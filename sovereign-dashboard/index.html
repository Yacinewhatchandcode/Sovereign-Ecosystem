<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß¨ AZIREM Sovereign Command Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- MediaPipe Hands for Gesture Control -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <!-- Three.js for 3D Mesh Topology -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Sovereign Core Assets -->
    <link rel="stylesheet" href="/static/sovereign_core.css">
    <script src="/static/sovereign_core.js" defer></script>

    <style>
        :root {
            /* Sovereign Glassmorphism v2 Palette */
            --bg-void: #010101;
            --bg-deep: rgba(5, 5, 5, 0.85);
            --bg-panel: rgba(15, 15, 15, 0.6);
            --bg-active: rgba(25, 25, 25, 0.4);

            /* High-Contrast Technical Accents */
            --neon-green: #00ff9d;
            /* Bliss Green */
            --neon-orange: #ff6b00;
            --neon-cyan: #00d2ff;
            --neon-red: #ff2d55;
            --neon-white: #ffffff;
            --neon-purple: #bc13fe;

            /* Text */
            --text-bright: #ffffff;
            --text-primary: #00ff9d;
            --text-secondary: #e0e0e0;
            --text-muted: #888888;

            /* Glass Depth */
            --glass-blur: blur(20px);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);

            /* Typography */
            --font-display: 'Orbitron', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --font-body: 'Inter', sans-serif;

            /* Radius */
            --radius-sharp: 0px;
            --radius-premium: 12px;
        }

        /* aSiReM Avatar Overlay */
        .asirem-avatar-overlay {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 120px;
            z-index: 1000;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 20px rgba(0, 255, 65, 0.4));
        }

        .asirem-avatar-overlay img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid #00FF41;
            object-fit: cover;
            background: rgba(0, 0, 0, 0.6);
        }

        .asirem-avatar-overlay.speaking {
            transform: scale(1.1);
            filter: drop-shadow(0 0 30px rgba(0, 255, 65, 0.8));
        }

        .asirem-avatar-overlay.speaking img {
            animation: subtle-bounce 0.5s infinite alternate;
            border-color: #FF0066;
        }

        @keyframes subtle-bounce {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-5px);
            }
        }

        /* Voice Waves */
        .voice-waves {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
            height: 20px;
            align-items: flex-end;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .asirem-avatar-overlay.speaking .voice-waves {
            opacity: 1;
        }

        .wave {
            width: 3px;
            background: #00FF41;
            border-radius: 1px;
            animation: wave-bounce 1s infinite alternate;
        }

        .wave:nth-child(2) {
            animation-delay: 0.1s;
            height: 10px;
        }

        .wave:nth-child(3) {
            animation-delay: 0.2s;
            height: 18px;
        }

        .wave:nth-child(4) {
            animation-delay: 0.3s;
            height: 8px;
        }

        @keyframes wave-bounce {
            0% {
                height: 4px;
            }

            100% {
                height: 18px;
                background: #FF0066;
            }
        }

        /* Speech Bubble */
        .asirem-speech-bubble {
            position: absolute;
            bottom: 130px;
            right: -20px;
            width: 220px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #00FF41;
            border-radius: 8px;
            padding: 10px;
            color: #00FF41;
            font-family: var(--font-body);
            font-size: 0.75rem;
            backdrop-filter: blur(5px);
            transform-origin: bottom right;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.8);
            z-index: 1001;
        }

        .asirem-speech-bubble.hidden {
            opacity: 0;
            transform: scale(0.8) translateY(20px);
            pointer-events: none;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--bg-void);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ============================================
           COSMIC BACKGROUND WITH PARTICLES
        ============================================ */
        .cosmic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background:
                linear-gradient(rgba(0, 255, 65, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 65, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            background-color: var(--bg-void);
            pointer-events: none;
        }

        .cosmic-bg::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg,
                    transparent,
                    transparent 1px,
                    rgba(0, 255, 65, 0.01) 2px,
                    rgba(0, 255, 65, 0.01) 3px);
            pointer-events: none;
        }

        @keyframes scanline {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(100%);
            }
        }

        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--neon-cyan);
            border-radius: 50%;
            animation: float 20s linear infinite;
            opacity: 0.6;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 0.8;
            }

            90% {
                opacity: 0.8;
            }

            100% {
                transform: translateY(-100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* ============================================
           HEADER - SOVEREIGN COMMAND BAR
        ============================================ */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: var(--border-main);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            padding-left: 200px;
            /* Space for aSiReM Avatar */
            z-index: 1000;
        }

        .api-console-btn {
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            padding: 0.5rem 1.2rem;
            border-radius: var(--radius-sharp);
            font-family: var(--font-display);
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            margin-right: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .api-console-btn:hover {
            background: var(--neon-green);
            color: var(--bg-void);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
        }

        .tracing-console-btn {
            background: rgba(255, 69, 0, 0.05);
            border: 1px solid var(--neon-orange);
            color: var(--neon-orange);
            padding: 0.5rem 1.2rem;
            border-radius: var(--radius-sharp);
            font-family: var(--font-display);
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            margin-right: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tracing-console-btn:hover {
            background: var(--neon-orange);
            color: var(--bg-void);
            box-shadow: 0 0 20px rgba(255, 69, 0, 0.4);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: var(--bg-panel);
            border: 1px solid var(--neon-green);
            border-radius: var(--radius-sharp);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            position: relative;
        }

        .logo-icon::after {
            content: '';
            position: absolute;
            inset: -2px;
            border: 1px solid var(--neon-green);
            opacity: 0.3;
            animation: logoPulse 2s infinite;
        }

        @keyframes logoPulse {
            0% {
                transform: scale(1);
                opacity: 0.3;
            }

            50% {
                transform: scale(1.1);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 0.3;
            }
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1.2rem;
        }

        .header-titles {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .logo-text {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 900;
            color: var(--neon-green);
            letter-spacing: 4px;
            line-height: 1;
            text-transform: uppercase;
        }

        .logo-subtitle {
            font-size: 0.75rem;
            color: var(--neon-cyan);
            letter-spacing: 2px;
            opacity: 0.8;
            text-transform: uppercase;
            font-weight: 500;
        }

        .status-cluster {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 255, 157, 0.1);
            border: 1px solid rgba(0, 255, 157, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            font-family: var(--font-mono);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: var(--neon-green);
            border-radius: 50%;
            animation: statusPulse 2s infinite;
            box-shadow: 0 0 10px var(--neon-green);
        }

        @keyframes statusPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }

        .evolution-counter {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            color: var(--neon-purple);
        }

        .evolution-counter span {
            color: var(--text-bright);
            font-weight: 600;
        }

        /* ============================================
           MAIN GRID LAYOUT
        ============================================ */
        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            grid-template-rows: auto 1fr;
            gap: 1.5rem;
            padding: 90px 1.5rem 1.5rem;
            min-height: 100vh;
        }

        /* ============================================
           LEFT SIDEBAR - AGENT FLEET
        ============================================ */
        .sidebar-left {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .panel {
            background: var(--bg-panel);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: var(--radius-premium);
            box-shadow: var(--glass-shadow);
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
        }

        .panel:hover {
            border-color: rgba(0, 255, 157, 0.4);
            box-shadow: 0 0 40px rgba(0, 255, 157, 0.1);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: #000;
            border-bottom: 1px solid #1a1a1a;
            position: relative;
        }

        .panel-header::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 2px;
            width: 30px;
            background: var(--neon-green);
        }

        .panel-title {
            font-family: var(--font-display);
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--neon-cyan);
            opacity: 0.8;
        }

        .panel-badge {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            background: rgba(0, 255, 65, 0.1);
            color: var(--neon-green);
            border: 1px solid rgba(0, 255, 65, 0.2);
            border-radius: 0;
        }

        .panel-content {
            padding: 1rem;
            max-height: 500px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #222 #000;
        }

        /* Agent Cards */
        .agent-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .agent-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.85rem;
            background: rgba(20, 20, 20, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-premium);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .agent-card:hover {
            border-color: var(--neon-green);
            background: #111;
            transform: scale(1.02);
            z-index: 10;
        }

        .agent-card.active {
            border-color: var(--neon-green);
            background: rgba(0, 255, 65, 0.03);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.1);
        }

        .agent-card.active::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 10px;
            width: 6px;
            height: 6px;
            background: var(--neon-green);
            border-radius: 50%;
            animation: pulse-green 1.5s infinite;
        }

        @keyframes pulse-green {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .agent-avatar {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            border-radius: var(--radius-sharp);
            font-size: 1.2rem;
            overflow: hidden;
            border: 1px solid #222;
            position: relative;
        }

        .agent-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 1;
            z-index: 1;
            filter: saturate(1.3) brightness(1.1);
        }

        .avatar-live-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 6px;
            height: 6px;
            background: var(--neon-red);
            border-radius: 50%;
            box-shadow: 0 0 5px var(--neon-red);
            z-index: 2;
            animation: livePulse 1s infinite;
        }

        .agent-card.active .agent-avatar {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
        }

        .agent-info {
            flex: 1;
            min-width: 0;
        }

        .agent-name {
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .agent-role {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        .agent-status {
            width: 8px;
            height: 8px;
            border-radius: 0;
            background: var(--neon-green);
        }

        .agent-status.thinking {
            background: var(--neon-cyan);
            animation: thinking 1s infinite;
        }

        .agent-status.evolving {
            background: var(--neon-orange);
            animation: evolving 0.5s infinite;
        }

        @keyframes thinking {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        @keyframes evolving {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.5);
            }
        }

        /* ============================================
           CENTER - VIDEO & STREAMING AREA
        ============================================ */
        .center-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Video Stream Panel */
        .video-panel {
            position: relative;
            border-radius: var(--radius-sharp);
            overflow: hidden;
            aspect-ratio: 16/9;
            background: #000;
            border: 1px solid #222;
        }

        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .video-player {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            background: linear-gradient(to bottom,
                    rgba(0, 0, 0, 0.3) 0%,
                    transparent 30%,
                    transparent 70%,
                    rgba(0, 0, 0, 0.5) 100%);
        }

        .video-hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }

        .hud-left {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mode-selector {
            display: flex;
            gap: 0.5rem;
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 0.25rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mode-tab {
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
            font-family: var(--font-display);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .mode-tab.active {
            color: var(--neon-cyan);
            background: rgba(0, 240, 255, 0.1);
        }

        .bytebot-vnc-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 5;
            background: #000;
        }

        .bytebot-vnc-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .hud-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: var(--neon-red);
            border-radius: 50%;
            animation: livePulse 1.5s infinite;
        }

        @keyframes livePulse {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 0 10px var(--neon-red);
            }

            50% {
                opacity: 0.5;
                box-shadow: 0 0 5px var(--neon-red);
            }
        }

        .video-bottom-hud {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
        }

        .current-agent-display {
            padding: 0.75rem 1.25rem;
            background: #000;
            border-radius: var(--radius-sharp);
            border: 1px solid var(--neon-cyan);
        }

        .current-agent-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
        }

        .current-agent-name {
            font-family: var(--font-display);
            font-size: 1rem;
            color: var(--neon-cyan);
            margin-top: 0.15rem;
            text-transform: uppercase;
        }

        /* Stream Controls */
        .stream-controls {
            display: flex;
            gap: 0.75rem;
            pointer-events: auto;
        }

        .control-btn {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(0, 240, 255, 0.2);
            border-color: var(--neon-cyan);
            transform: scale(1.05);
        }

        /* Activity Stream */
        .activity-panel {
            flex: 1;
            min-height: 200px;
        }

        .activity-stream {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-glass);
            border-radius: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-sovereign);
            border-radius: 8px;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-text {
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .activity-text .highlight {
            color: var(--neon-cyan);
            font-weight: 600;
        }

        .activity-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
            margin-top: 0.25rem;
        }

        /* ============================================
           RIGHT SIDEBAR - EVOLUTION METRICS
        ============================================ */
        .sidebar-right {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .metric-card {
            padding: 1rem;
            background: var(--bg-glass);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            border-color: var(--neon-cyan);
            transform: translateY(-2px);
        }

        .metric-value {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 700;
            background: var(--gradient-sovereign);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .metric-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.25rem;
        }

        .metric-trend {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .metric-trend.up {
            color: var(--neon-green);
        }

        .metric-trend.down {
            color: var(--neon-red);
        }

        /* Evolution Progress */
        .evolution-section {
            padding: 1rem;
        }

        .evolution-bar-container {
            margin-bottom: 1rem;
        }

        .evolution-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .evolution-bar {
            height: 6px;
            background: #111;
            border-radius: 0;
            overflow: hidden;
            border: 1px solid #222;
        }

        .evolution-bar-fill {
            height: 100%;
            background: var(--gradient-cyber);
            border-radius: 0;
            transition: width 0.5s ease;
        }

        /* Knowledge Graph Mini */
        .knowledge-mini {
            padding: 1rem;
        }

        .knowledge-nodes {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .knowledge-node {
            padding: 0.25rem 0.6rem;
            background: #000;
            border: 1px solid #333;
            border-radius: var(--radius-sharp);
            font-size: 0.7rem;
            font-family: var(--font-mono);
            color: var(--neon-cyan);
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .knowledge-node:hover {
            background: rgba(159, 79, 255, 0.2);
            transform: scale(1.05);
        }

        /* Terminal Output */
        .terminal-panel {
            flex: 1;
            min-height: 150px;
        }

        .terminal-content {
            height: 250px;
            overflow-y: auto;
            padding: 1rem;
            background: #000;
            border: 1px solid #111;
            border-radius: var(--radius-sharp);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            line-height: 1.6;
            scrollbar-width: thin;
            scrollbar-color: #222 #000;
        }

        .terminal-line {
            display: flex;
            gap: 0.5rem;
        }

        .terminal-prompt {
            color: var(--neon-green);
        }

        .terminal-text {
            color: var(--text-secondary);
        }

        .terminal-highlight {
            color: var(--neon-cyan);
        }

        .terminal-warning {
            color: var(--neon-orange);
        }

        .terminal-success {
            color: var(--neon-green);
        }

        /* ============================================
           SCROLLBAR STYLING
        ============================================ */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 240, 255, 0.3);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 240, 255, 0.5);
        }

        /* ============================================
           RESPONSIVE
        ============================================ */
        @media (max-width: 1400px) {
            .main-container {
                grid-template-columns: 250px 1fr 300px;
            }
        }

        @media (max-width: 1100px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .sidebar-left,
            .sidebar-right {
                display: none;
            }
        }

        /* aSiReM Avatar Styles */
        .asirem-avatar {
            position: fixed;
            top: 15px;
            left: 20px;
            z-index: 10001;
            width: 130px;
            height: 130px;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .avatar-image {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid #FFD700;
            box-shadow: 0 0 30px rgba(138, 43, 226, 0.8);
            transition: all 0.5s ease;
            animation: avatarPulse 3s infinite;
            cursor: pointer;
            object-fit: cover;
            background: var(--bg-void);
        }

        .avatar-image:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 0 50px rgba(138, 43, 226, 1);
            border-color: var(--neon-cyan);
        }

        .speech-bubble {
            position: absolute;
            left: 140px;
            top: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 18px 25px;
            border-radius: 20px;
            border-top-left-radius: 5px;
            width: 320px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            animation: bubbleAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10002;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .speech-bubble::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 20px;
            border: 15px solid transparent;
            border-right-color: #667eea;
        }

        .speech-bubble p {
            margin: 0;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.5;
            font-family: var(--font-display);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        @keyframes avatarPulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 30px rgba(138, 43, 226, 0.8);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 50px rgba(138, 43, 226, 1);
            }
        }

        @keyframes bubbleAppear {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes statusPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Sovereign Modal Overlay */
        .sovereign-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(15px);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sovereign-modal.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            width: 95%;
            height: 90%;
            background: #111;
            /* Dark background for iframe container */
            border: 1px solid var(--neon-cyan);
            border-radius: var(--radius-premium);
            box-shadow: 0 0 50px rgba(0, 240, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .modal-header {
            padding: 0.8rem 1.5rem;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid rgba(0, 240, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--neon-cyan);
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-muted);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
        }

        .modal-close:hover {
            border-color: var(--neon-red);
            color: var(--neon-red);
            transform: rotate(90deg);
        }

        .modal-iframe {
            flex: 1;
            border: none;
            width: 100%;
            height: 100%;
            background: #000;
        }
    </style>
</head>

<body>
    <!-- aSiReM Avatar Overlay -->
    <div id="asirem-avatar-container" class="asirem-avatar">
        <img id="asirem-avatar-img" src="assets/asirem/asirem_avatar_idle.png" alt="aSiReM" class="avatar-image"
            title="aSiReM - Sovereign Master Orchestrator">
        <div id="asirem-speech-bubble" class="speech-bubble hidden">
            <p id="asirem-speech-text"></p>
        </div>
        <div class="avatar-status-indicator" id="asirem-status-indicator"
            style="position: absolute; bottom: 10px; right: 10px; width: 20px; height: 20px; border-radius: 50%; background: #00ff41; border: 2px solid white; box-shadow: 0 0 10px #00ff41; animation: statusPulse 2s infinite;">
        </div>
    </div>

    <!-- Sovereign Modal -->
    <div id="sovereign-modal" class="sovereign-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span style="font-size: 1.5rem;">üî≠</span>
                    <span>SOVEREIGN OBSERVABILITY LAYER</span>
                    <span class="panel-badge"
                        style="margin-left: 1rem; background: rgba(0, 240, 255, 0.1); border-color: var(--neon-cyan); color: var(--neon-cyan);">LIVE
                        TRACE CONTROL</span>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <a href="http://localhost:5173" target="_blank"
                        style="font-size: 0.8rem; color: var(--text-muted); text-decoration: none; border-bottom: 1px dotted var(--text-muted);">Backend:
                        :5173</a>
                    <a href="http://localhost:5173" target="_blank"
                        style="font-size: 0.8rem; color: var(--text-muted); text-decoration: none; border-bottom: 1px dotted var(--text-muted);">Frontend:
                        :5173</a>
                    <button class="modal-close" onclick="closeOpikModal()">‚úï</button>
                </div>
            </div>
            <iframe id="opik-iframe" class="modal-iframe" src=""></iframe>
        </div>
    </div>

    <!-- Cosmic Background -->
    <div class="cosmic-bg">
        <div class="particles" id="particles"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo-icon">üß¨</div>
            <div class="header-titles">
                <span class="logo-text">aSiReM SOVEREIGN</span>
                <span class="logo-subtitle">Sovereign Master Orchestrator</span>
            </div>
        </div>

        <div class="status-badge" style="background: rgba(0, 195, 255, 0.1); border-color: rgba(0, 195, 255, 0.3);">
            <div class="status-dot" style="background: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan);"></div>
            <span style="color: var(--neon-cyan); font-weight: 700;">DELEGATION: ACTIVE</span>
        </div>
        <div class="status-badge" style="background: rgba(255, 69, 0, 0.1); border-color: rgba(255, 69, 0, 0.3);">
            <div class="status-dot" style="background: var(--neon-orange); box-shadow: 0 0 10px var(--neon-orange);">
            </div>
            <span id="mesh-counter">MESH: 1,176 AGENTS</span>
        </div>
        <div class="status-cluster">
            <button class="api-console-btn" onclick="openApiConsole()" title="Sovereign API Workbench">
                <span>‚ö°</span> API
            </button>
            <button class="tracing-console-btn" onclick="openOpikModal()" title="Sovereign Observability Layer">
                <span>üî≠</span> OBSERVABILITY
            </button>
            <div class="evolution-counter">
                Evolution Cycle: <span id="evolution-cycle">0</span>
            </div>
            <div class="status-badge">
                <div class="status-dot" id="main-status-dot"></div>
                <span id="connection-status">Initializing...</span>
            </div>
        </div>
    </header>

    <script>
        // Modal Helper Function
        function showModal(title, contentHtml) {
            // Check if generic modal logic exists, otherwise implement simple one
            // Ideally we reuse the existing modals or create dynamic one

            // For now, let's use the api-modal as a container if possible or create one
            let modal = document.getElementById('dynamic-modal');
            if (!modal) {
                // Create dynamic modal structure
                const backdrop = document.createElement('div');
                backdrop.id = 'dynamic-modal';
                backdrop.className = 'api-modal'; // Reuse api-modal styles
                backdrop.style.display = 'none';
                backdrop.innerHTML = `
                    <div class="api-backdrop" onclick="closeDynamicModal()"></div>
                    <div class="api-container" style="max-width: 800px;">
                        <div class="api-header">
                            <div class="api-title">
                                <span>‚ÑπÔ∏è</span>
                                <h2 id="dynamic-modal-title">Info</h2>
                            </div>
                            <button class="viewer-close-btn" onclick="closeDynamicModal()">‚úï</button>
                        </div>
                        <div class="api-body" style="padding: 20px; overflow-y: auto; max-height: 70vh;">
                            <div id="dynamic-modal-content"></div>
                        </div>
                    </div>
                `;
                document.body.appendChild(backdrop);
                modal = backdrop;
            }

            document.getElementById('dynamic-modal-title').textContent = title || "Info";
            document.getElementById('dynamic-modal-content').innerHTML = contentHtml || "";

            modal.style.display = 'flex';
            modal.classList.remove('hidden');
        }

        function closeDynamicModal() {
            const modal = document.getElementById('dynamic-modal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.add('hidden');
            }
        }

        // Action Log Viewer
        function openAgentActionLog() {
            logTerminal("üìä Fetching Agent Action Log...");
            fetch('/api/agent/action-log')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const logs = data.logs;
                        let logHtml = '<table style="width:100%; border-collapse: collapse; color: #eee; font-size: 0.8rem;">';
                        logHtml += '<tr style="border-bottom: 1px solid #444; text-align:left;"><th>Time</th><th>Agent</th><th>Action</th><th>Target</th><th>Status</th></tr>';

                        logs.forEach(log => {
                            const statusColor = log.success ? '#00ff41' : '#ff0055';
                            logHtml += `
                                <tr style="border-bottom: 1px solid #222;">
                                    <td style="padding: 8px;">${new Date(log.timestamp).toLocaleTimeString()}</td>
                                    <td style="padding: 8px;">${log.agent}</td>
                                    <td style="padding: 8px;">${log.action}</td>
                                    <td style="padding: 8px; font-family:monospace;">${log.target || '-'}</td>
                                    <td style="padding: 8px; color: ${statusColor};">${log.success ? 'SUCCESS' : 'FAIL'}</td>
                                </tr>
                            `;
                        });
                        logHtml += '</table>';

                        showModal('AGENT_ACTION_LOG', logHtml);
                    } else {
                        logTerminal("‚ùå Failed to fetch logs: " + data.error);
                    }
                })
                .catch(e => logTerminal("‚ùå Error fetching logs: " + e.message));
        }
    </script>
    <div class="main-container">
        <!-- Left Sidebar: Agent Fleet -->
        <aside class="sidebar-left">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">ü§ñ Agent Fleet</span>
                    <span class="panel-badge" id="active-agents-count">0 Active</span>
                </div>
                <div class="panel-content">
                    <div class="agent-grid" id="agent-grid">
                        <!-- Agents will be populated dynamically -->
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">‚ö° Quick Actions</span>
                </div>
                <div class="panel-content">
                    <div class="agent-grid">
                        <div class="agent-card" onclick="triggerEvolutionCycle()">
                            <div class="agent-avatar">üîÑ</div>
                            <div class="agent-info">
                                <div class="agent-name">Run Evolution</div>
                                <div class="agent-role">Trigger scan cycle</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="toggleAutoEvolve()">
                            <div class="agent-avatar">üîÅ</div>
                            <div class="agent-info">
                                <div class="agent-name" id="auto-evolve-label">Auto-Evolve: OFF</div>
                                <div class="agent-role">Continuous mode</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="searchWeb()">
                            <div class="agent-avatar">üåê</div>
                            <div class="agent-info">
                                <div class="agent-name">Web Search</div>
                                <div class="agent-role">Find new patterns</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="auditSystemMesh()">
                            <div class="agent-avatar">üßµ</div>
                            <div class="agent-info">
                                <div class="agent-name">Mesh Audit</div>
                                <div class="agent-role">1,176-Agent Health Check</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="openApiConsole()">
                            <div class="agent-avatar">üõ†Ô∏è</div>
                            <div class="agent-info">
                                <div class="agent-name">API Workbench</div>
                                <div class="agent-role">Low-level overrides</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="asiremSpeak()"
                            style="border-right: 2px solid var(--neon-green);">
                            <div class="agent-avatar">üó£Ô∏è</div>
                            <div class="agent-info">
                                <div class="agent-name" style="color: var(--neon-green);">aSiReM Speak</div>
                                <div class="agent-role">Real-time voice</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="generateVeo3()"
                            style="border-right: 2px solid var(--neon-orange);">
                            <div class="agent-avatar">üé¨</div>
                            <div class="agent-info">
                                <div class="agent-name" style="color: var(--neon-orange);">Veo3 Generate</div>
                                <div class="agent-role">AI video creation</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="generateNarrative()"
                            style="border-right: 2px solid var(--neon-cyan);">
                            <div class="agent-avatar">üé≠</div>
                            <div class="agent-info">
                                <div class="agent-name" style="color: var(--neon-cyan);">Cinematic Narrative</div>
                                <div class="agent-role">Full story production</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="showCredits()">
                            <div class="agent-avatar">üíé</div>
                            <div class="agent-info">
                                <div class="agent-name">Veo3 Credits</div>
                                <div class="agent-role" id="credits-display">~625 videos left</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="triggerIntegratedScan()"
                            style="border-color: rgba(0, 240, 255, 0.4);">
                            <div class="agent-avatar">üê≥</div>
                            <div class="agent-info">
                                <div class="agent-name" style="color: var(--neon-cyan);">Integrated Scan</div>
                                <div class="agent-role">ByteBot + DeepSeek</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="openPodcastPanel()"
                            style="border-color: rgba(255, 0, 170, 0.4); background: linear-gradient(135deg, rgba(255, 0, 170, 0.1), rgba(159, 79, 255, 0.1));">
                            <div class="agent-avatar">üéôÔ∏è</div>
                            <div class="agent-info">
                                <div class="agent-name" style="color: var(--neon-pink);">AZIREM Podcast</div>
                                <div class="agent-role">Live conversation</div>
                            </div>
                        </div>

                        <!-- AGENT ACTION CONTROL PANEL -->
                        <div class="agent-action-panel"
                            style="margin-top: 15px; padding: 10px; border: 1px solid rgba(0, 255, 65, 0.3); border-radius: 8px; background: rgba(0, 255, 65, 0.05);">
                            <div
                                style="font-size: 0.75rem; color: var(--neon-cyan); margin-bottom: 8px; font-weight: bold; display: flex; justify-content: space-between;">
                                <span>üéØ BYTEBOT-FIRST ACTUATION</span>
                                <span style="font-size: 0.6rem; opacity: 0.7;">HOST SAFETY: 100%</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                <button onclick="agentAction_AziremCode()" class="action-btn"
                                    style="padding: 6px 8px; font-size: 0.65rem; background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 140, 0, 0.2)); border: 1px solid rgba(255, 215, 0, 0.4); border-radius: 4px; color: #FFD700; cursor: pointer;">
                                    üëë AZIREM<br><span style="font-size: 0.55rem; opacity: 0.8;">Create Code</span>
                                </button>
                                <button onclick="agentAction_BumblebeeResearch()" class="action-btn"
                                    style="padding: 6px 8px; font-size: 0.65rem; background: linear-gradient(135deg, rgba(255, 165, 0, 0.2), rgba(255, 200, 0, 0.2)); border: 1px solid rgba(255, 165, 0, 0.4); border-radius: 4px; color: #FFA500; cursor: pointer;">
                                    üêù BUMBLEBEE<br><span style="font-size: 0.55rem; opacity: 0.8;">Research</span>
                                </button>
                                <button onclick="agentAction_ScannerExplore()" class="action-btn"
                                    style="padding: 6px 8px; font-size: 0.65rem; background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 150, 255, 0.2)); border: 1px solid rgba(0, 212, 255, 0.4); border-radius: 4px; color: #00D4FF; cursor: pointer;">
                                    üì° SCANNER<br><span style="font-size: 0.55rem; opacity: 0.8;">Explore</span>
                                </button>
                                <button onclick="agentAction_SpectraPreview()" class="action-btn"
                                    style="padding: 6px 8px; font-size: 0.65rem; background: linear-gradient(135deg, rgba(159, 79, 255, 0.2), rgba(255, 0, 170, 0.2)); border: 1px solid rgba(159, 79, 255, 0.4); border-radius: 4px; color: #9F4FFF; cursor: pointer;">
                                    üåà SPECTRA<br><span style="font-size: 0.55rem; opacity: 0.8;">Preview UI</span>
                                </button>
                            </div>
                            <button onclick="openAgentActionLog()"
                                style="width: 100%; margin-top: 8px; padding: 5px; font-size: 0.6rem; background: rgba(0, 255, 65, 0.1); border: 1px solid rgba(0, 255, 65, 0.3); border-radius: 4px; color: var(--neon-green); cursor: pointer;">
                                üìä View Action Log
                            </button>

                            <!-- Recording Controls -->
                            <div
                                style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255, 0, 102, 0.3);">
                                <div style="font-size: 0.65rem; color: #FF0066; margin-bottom: 6px;">üé¨ RECORDING</div>
                                <div style="display: flex; gap: 4px;">
                                    <button id="rec-start-btn" onclick="startAgentRecording()"
                                        style="flex: 1; padding: 5px; font-size: 0.55rem; background: rgba(255, 0, 102, 0.15); border: 1px solid rgba(255, 0, 102, 0.4); border-radius: 4px; color: #FF0066; cursor: pointer;">
                                        ‚è∫Ô∏è Start
                                    </button>
                                    <button id="rec-stop-btn" onclick="stopAgentRecording()"
                                        style="flex: 1; padding: 5px; font-size: 0.55rem; background: rgba(100, 100, 100, 0.15); border: 1px solid rgba(100, 100, 100, 0.4); border-radius: 4px; color: #888; cursor: pointer;"
                                        disabled>
                                        ‚èπÔ∏è Stop
                                    </button>
                                </div>
                                <div id="rec-status"
                                    style="font-size: 0.5rem; color: #888; text-align: center; margin-top: 4px;">Ready
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel" style="margin-top: 15px;">
                <div class="panel-header">
                    <span class="panel-title">üèÜ Expert Workflows</span>
                    <span class="panel-badge" style="border-color: #00d2ff; color: #00d2ff;">BYTEBOT PLUGGED</span>
                </div>
                <div class="panel-content">
                    <div class="agent-grid">
                        <div class="agent-card" onclick="triggerDeepSearch()">
                            <div class="agent-avatar" style="border-color: #00ff9d;">üß†</div>
                            <div class="agent-info">
                                <div class="agent-name" style="color: #00ff9d;">Deep Web Search</div>
                                <div class="agent-role">Research & Report Gen</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="triggerProductIdea()">
                            <div class="agent-avatar" style="border-color: #ff6b00;">üí°</div>
                            <div class="agent-info">
                                <div class="agent-name" style="color: #ff6b00;">Product Idea 2026</div>
                                <div class="agent-role">Ideation to Pitch Deck</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="triggerRPABuilder()">
                            <div class="agent-avatar" style="border-color: #00d2ff;">üè≠</div>
                            <div class="agent-info">
                                <div class="agent-name" style="color: #00d2ff;">RPA App Factory</div>
                                <div class="agent-role">Full-Stack App Builder</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="triggerDesktopControl()">
                            <div class="agent-avatar" style="border-color: #bc13fe;">üñ•Ô∏è</div>
                            <div class="agent-info">
                                <div class="agent-name" style="color: #bc13fe;">Desktop Sovereign</div>
                                <div class="agent-role">System Auditor & Control</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="triggerNebulaOrchestration()">
                            <div class="agent-avatar" style="border-color: #ff2d55; box-shadow: 0 0 15px #ff2d55;">üåå
                            </div>
                            <div class="agent-info">
                                <div class="agent-name" style="color: #ff2d55;">Nebula Orchestrator</div>
                                <div class="agent-role">Synaptic Blueprint & Kinetic Actuation</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="triggerTimeParallel()">
                            <div class="agent-avatar" style="border-color: #bc13fe; box-shadow: 0 0 15px #bc13fe;">‚åõ
                            </div>
                            <div class="agent-info">
                                <div class="agent-name" style="color: #bc13fe;">Chronos Parallel</div>
                                <div class="agent-role">Multi-Agent Acceleration Matrix</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="triggerCognitiveProtocol()">
                            <div class="agent-avatar" style="border-color: #00d4ff; box-shadow: 0 0 15px #00d4ff;">üß†
                            </div>
                            <div class="agent-info">
                                <div class="agent-name" style="color: #00d4ff;">Cognitive Deep Protocol</div>
                                <div class="agent-role">Neural Synthesis & Validation</div>
                            </div>
                        </div>
                        <div class="agent-card" onclick="triggerZenArchitect()">
                            <div class="agent-avatar" style="border-color: #ff9d00; box-shadow: 0 0 15px #ff9d00;">‚õ©Ô∏è
                            </div>
                            <div class="agent-info">
                                <div class="agent-name" style="color: #ff9d00;">ZenArchitect Expert</div>
                                <div class="agent-role">Product Manager + Specialist Builder</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Center: Video & Activity -->
        <main class="center-content">
            <!-- Video Stream Panel -->
            <div class="video-panel">
                <div class="video-container">
                    <video class="video-player" id="video-player" autoplay muted loop>
                        <source src="assets/asirem-video.mp4" type="video/mp4">
                        <source src="assets/bg-loop.mp4" type="video/mp4">
                    </video>
                    <div id="bytebot-vnc" class="bytebot-vnc-container">
                        <!-- Direct VNC iframe - loads immediately -->
                        <iframe
                            src="http://localhost:9990/novnc/vnc.html?host=localhost&port=9990&path=websockify&resize=scale&autoconnect=true"
                            style="width:100%; height:100%; border:none;"
                            allow="clipboard-read; clipboard-write; autoplay"></iframe>
                    </div>

                    <!-- 3D NUCLEUS MESH CANVAS -->
                    <div id="nucleus-3d" style="display: none; width: 100%; height: 100%; cursor: crosshair;"></div>
                    <div class="video-overlay"></div>

                    <!-- Top HUD -->
                    <div class="video-hud">
                        <div class="hud-left">
                            <div class="hud-badge">
                                <div class="live-dot"></div>
                                <span id="video-status">SOVEREIGN STREAM</span>
                            </div>
                            <div class="mode-selector">
                                <div class="mode-tab active" onclick="setVideoMode('agent')" id="tab-agent">AGENT VIEW
                                </div>
                                <div class="mode-tab" onclick="setVideoMode('bytebot')" id="tab-bytebot">BYTEBOT DESKTOP
                                </div>
                                <div class="mode-tab" onclick="setVideoMode('nucleus')" id="tab-nucleus">3D NUCLEUS
                                </div>
                            </div>
                            <div class="hud-badge"
                                style="margin-top: 8px; border-color: var(--neon-cyan); color: var(--neon-cyan); font-size: 0.65rem;">
                                <span id="actuation-status">MECH ACTUATION: ONLINE</span>
                            </div>
                        </div>
                        <div class="hud-badge">
                            <span id="stream-time">00:00:00</span>
                        </div>
                    </div>

                    <!-- aSiReM Avatar Overlay -->
                    <div id="asirem-avatar-overlay" class="asirem-avatar-overlay">
                        <video id="asirem-live-video" class="asirem-live-video hidden" autoplay playsinline
                            style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 2px solid var(--neon-cyan);"></video>
                        <img id="asirem-head" src="assets/character/Gemini_Generated_Image_74pu4274pu4274pu.png"
                            alt="aSiReM">
                        <div class="voice-waves">
                            <div class="wave"></div>
                            <div class="wave"></div>
                            <div class="wave"></div>
                            <div class="wave"></div>
                        </div>
                        <div id="asirem-speech-bubble" class="asirem-speech-bubble hidden">
                            <div class="bubble-content" id="bubble-content"></div>
                        </div>
                        <div class="avatar-controls"
                            style="position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px;">
                            <button id="toggle-live-avatar" onclick="toggleLiveAvatar()" class="mini-hud-btn"
                                style="background: rgba(0, 240, 255, 0.2); border: 1px solid var(--neon-cyan); color: var(--neon-cyan); border-radius: 10px; padding: 2px 8px; font-size: 0.6rem; cursor: pointer; transition: all 0.3s;"
                                title="Enable Live Webcam Avatar">üé• LIVE</button>
                        </div>
                    </div>

                    <!-- Bottom HUD -->
                    <div class="video-bottom-hud">
                        <div class="current-agent-display">
                            <div class="current-agent-label">Active Agent</div>
                            <div class="current-agent-name" id="current-agent-name">Initializing...</div>
                        </div>

                        <div class="stream-controls">
                            <button class="control-btn" onclick="toggleMute()" title="Toggle Audio">üîá</button>
                            <button class="control-btn" onclick="togglePlay()" title="Play/Pause">‚èØÔ∏è</button>
                            <button class="control-btn" onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VOICE CLONING PIPELINE VISUALIZER -->
            <div class="panel pipeline-panel" id="pipeline-panel" style="display: none;">
                <div class="panel-header">
                    <span class="panel-title">üéôÔ∏è Voice Cloning Pipeline</span>
                    <span class="panel-badge" id="pipeline-status">Idle</span>
                </div>
                <div class="panel-content">
                    <div class="pipeline-stages">
                        <div class="pipeline-stage" id="stage-narrative">
                            <div class="stage-icon">üìù</div>
                            <div class="stage-info">
                                <div class="stage-name">Narrative</div>
                                <div class="stage-status" id="status-narrative">Waiting</div>
                            </div>
                            <div class="stage-progress">
                                <div class="progress-bar" id="progress-narrative"></div>
                            </div>
                        </div>

                        <div class="pipeline-arrow">‚Üí</div>

                        <div class="pipeline-stage" id="stage-tts">
                            <div class="stage-icon">üé§</div>
                            <div class="stage-info">
                                <div class="stage-name">Voice Synthesis</div>
                                <div class="stage-status" id="status-tts">Waiting</div>
                            </div>
                            <div class="stage-progress">
                                <div class="progress-bar" id="progress-tts"></div>
                            </div>
                        </div>

                        <div class="pipeline-arrow">‚Üí</div>

                        <div class="pipeline-stage" id="stage-lipsync">
                            <div class="stage-icon">üëÑ</div>
                            <div class="stage-info">
                                <div class="stage-name">Lip Sync</div>
                                <div class="stage-status" id="status-lipsync">Waiting</div>
                            </div>
                            <div class="stage-progress">
                                <div class="progress-bar" id="progress-lipsync"></div>
                            </div>
                        </div>

                        <div class="pipeline-arrow">‚Üí</div>

                        <div class="pipeline-stage" id="stage-video">
                            <div class="stage-icon">üé¨</div>
                            <div class="stage-info">
                                <div class="stage-name">Final Video</div>
                                <div class="stage-status" id="status-video">Waiting</div>
                            </div>
                            <div class="stage-progress">
                                <div class="progress-bar" id="progress-video"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Details -->
                    <div class="pipeline-details" id="pipeline-details">
                        <div class="detail-row">
                            <span class="detail-label">Voice Model:</span>
                            <span class="detail-value" id="detail-voice">XTTS v2 / F5-TTS</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Reference Audio:</span>
                            <span class="detail-value" id="detail-reference">MyVoice.wav</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Character Asset:</span>
                            <span class="detail-value" id="detail-character">Story Bible (15 images)</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Output Path:</span>
                            <span class="detail-value" id="detail-output">sovereign-dashboard/generated/</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Stream -->

            <div class="panel activity-panel">
                <div class="panel-header">
                    <span class="panel-title">üì° Real-Time Activity</span>
                    <span class="panel-badge" id="activity-count">0 events</span>
                </div>
                <div class="panel-content">
                    <div class="activity-stream" id="activity-stream">
                        <!-- Activities populated dynamically -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar: Evolution Metrics -->
        <aside class="sidebar-right">
            <!-- Metrics -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üìä Evolution Metrics</span>
                </div>
                <div class="panel-content">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value" id="metric-patterns">0</div>
                            <div class="metric-label">Patterns</div>
                            <div class="metric-trend up" id="patterns-trend">‚Üë +0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="metric-files">0</div>
                            <div class="metric-label">Files Scanned</div>
                            <div class="metric-trend up" id="files-trend">‚Üë +0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="metric-knowledge">0</div>
                            <div class="metric-label">Knowledge</div>
                            <div class="metric-trend up" id="knowledge-trend">‚Üë +0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="metric-agents">0</div>
                            <div class="metric-label">Spawned</div>
                            <div class="metric-trend up" id="agents-trend">‚Üë +0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evolution Progress -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üß¨ Evolution Progress</span>
                </div>
                <div class="evolution-section">
                    <div class="evolution-bar-container">
                        <div class="evolution-bar-label">
                            <span>Scan Phase</span>
                            <span id="scan-percent">0%</span>
                        </div>
                        <div class="evolution-bar">
                            <div class="evolution-bar-fill" id="scan-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="evolution-bar-container">
                        <div class="evolution-bar-label">
                            <span>Learn Phase</span>
                            <span id="learn-percent">0%</span>
                        </div>
                        <div class="evolution-bar">
                            <div class="evolution-bar-fill" id="learn-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="evolution-bar-container">
                        <div class="evolution-bar-label">
                            <span>Evolve Phase</span>
                            <span id="evolve-percent">0%</span>
                        </div>
                        <div class="evolution-bar">
                            <div class="evolution-bar-fill" id="evolve-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Knowledge Graph -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üß† Knowledge Graph</span>
                    <span class="panel-badge" id="knowledge-count">0 nodes</span>
                </div>
                <div class="knowledge-mini">
                    <div class="knowledge-nodes" id="knowledge-nodes">
                        <!-- Knowledge nodes populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Pattern Distribution -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üìà Pattern Distribution</span>
                </div>
                <div class="panel-content" style="padding: 1rem;">
                    <canvas id="patternChart" style="max-height: 200px;"></canvas>
                </div>
            </div>

            <!-- Terminal -->
            <div class="panel terminal-panel">
                <div class="panel-header">
                    <span class="panel-title">üíª System Log</span>
                </div>
                <div class="terminal-content" id="terminal">
                    <div class="terminal-line">
                        <span class="terminal-prompt">$</span>
                        <span class="terminal-text">Sovereign Command Center initialized...</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- AGENT VIEWER MODAL - Individual Agent Real-Time Stream -->
    <div id="agent-viewer-modal" class="agent-viewer-modal hidden">
        <div class="agent-viewer-backdrop" onclick="closeAgentViewer()"></div>
        <div class="agent-viewer-container">
            <div class="agent-viewer-header">
                <div class="agent-viewer-title">
                    <span id="viewer-agent-icon">ü§ñ</span>
                    <span id="viewer-agent-name">Agent Name</span>
                    <span class="viewer-status" id="viewer-status">LIVE</span>
                    <div id="nexus-countdown-badge" class="nexus-countdown-badge hidden">
                        <span class="nexus-pulse"></span>
                        MISSION END: <span id="nexus-timer">00:00</span>
                    </div>
                </div>
                <div class="viewer-controls">
                    <button class="viewer-capture-btn" id="live-capture-btn" onclick="toggleLiveCapture()">
                        üé¨ Start Live Capture
                    </button>
                    <button class="viewer-gesture-btn" id="gesture-control-btn" onclick="toggleGestureControl()">
                        üñêÔ∏è Enable Gestures
                    </button>
                    <button class="viewer-close-btn" onclick="closeAgentViewer()">‚úï</button>
                </div>
            </div>
            <div class="agent-viewer-body">
                <div class="agent-viewer-video-container" id="viewer-canvas-container">
                    <!-- MAIN VISUAL CONTENT SLOT -->
                    <div id="viewer-visual-slot"
                        style="width:100%; height:100%; position:relative; display:flex; align-items:center; justify-content:center;">
                        <!-- REAL-TIME VISUALIZATION CANVAS -->
                        <canvas id="agent-canvas" width="960" height="540"></canvas>

                        <!-- IDLE AGENT VIDEO STREAM -->
                        <video id="viewer-video" autoplay muted loop
                            style="width:100%;height:100%;object-fit:contain;position:absolute;top:0;left:0;z-index:1;"></video>

                        <!-- Live Screen Capture Image (OpenAI Operator style) -->
                        <img id="live-capture-img"
                            style="display:none;width:100%;height:100%;object-fit:contain;position:absolute;top:0;left:0;z-index:5;" />
                    </div>

                    <!-- OVERLAYS (Must stay persistent) -->
                    <!-- Matrix Code Overlay -->
                    <div class="viewer-matrix-overlay" id="viewer-matrix" style="z-index:7;"></div>

                    <!-- GESTURE CONTROL OVERLAY -->
                    <!-- Live Webcam Video Feed -->
                    <video id="gesture-webcam-video" autoplay playsinline muted
                        style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:9;transform:scaleX(-1);"></video>

                    <canvas id="gesture-overlay-canvas"
                        style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;z-index:10;pointer-events:none;"></canvas>

                    <!-- Gesture HUD -->
                    <div id="gesture-hud" class="gesture-hud hidden" style="z-index:15;">
                        <div class="gesture-indicator" id="gesture-indicator">üëÜ POINTING</div>
                        <div class="gesture-action" id="gesture-action">Controlling cursor</div>
                    </div>

                    <!-- Gesture Reference Overlay -->
                    <div id="gesture-reference" class="gesture-reference hidden">
                        <div class="gesture-ref-title">üñêÔ∏è Gesture Commands</div>
                        <div class="gesture-ref-item">üëÜ Point ‚Üí Cursor</div>
                        <div class="gesture-ref-item">ü§è Pinch ‚Üí Click</div>
                        <div class="gesture-ref-item">‚úä Fist ‚Üí Drag</div>
                        <div class="gesture-ref-item">‚úã Palm ‚Üí Stop</div>
                        <div class="gesture-ref-item">üëàüëâ Swipe ‚Üí Navigate</div>
                        <div class="gesture-ref-item">‚úåÔ∏è Peace ‚Üí Right-Click</div>

                        <!-- ByteBot Mode Toggle -->
                        <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid rgba(0, 255, 65, 0.3);">
                            <div style="font-size: 0.65rem; color: #FF0066; margin-bottom: 6px;">üéØ CONTROL TARGET</div>
                            <div style="display: flex; gap: 4px;">
                                <button id="mode-local-btn" onclick="setGestureMode('local')"
                                    style="flex: 1; padding: 5px; font-size: 0.55rem; background: rgba(0, 255, 65, 0.25); border: 2px solid #00FF41; border-radius: 4px; color: #00FF41; cursor: pointer;">
                                    üñ•Ô∏è LOCAL<br>macOS
                                </button>
                                <button id="mode-bytebot-btn" onclick="setGestureMode('bytebot')"
                                    style="flex: 1; padding: 5px; font-size: 0.55rem; background: rgba(255, 0, 102, 0.1); border: 1px solid rgba(255, 0, 102, 0.4); border-radius: 4px; color: #FF0066; cursor: pointer;">
                                    üê≥ BYTEBOT<br>Ubuntu
                                </button>
                            </div>
                            <div id="gesture-mode-status"
                                style="font-size: 0.5rem; color: #00FF41; text-align: center; margin-top: 4px;">Mode:
                                LOCAL</div>
                        </div>
                    </div>

                    <div class="viewer-video-overlay">
                        <div class="viewer-live-badge" id="viewer-live-badge">‚óè LIVE ACTIVITY</div>
                        <div class="viewer-agent-role" id="viewer-role">Processing...</div>
                    </div>

                    <!-- Agent Thought Stream Overlay -->
                    <div id="agent-thought-stream" style="position:absolute; bottom:12px; left:12px; right:12px; height:80px; 
                                background:rgba(0,10,2,0.85); border:1px solid rgba(0,255,65,0.4); 
                                color:#00FF41; font-family:'Fira Code', monospace; font-size:0.6rem; 
                                padding:8px; z-index:50; overflow-y:hidden; pointer-events:none; 
                                border-radius:4px; box-shadow:0 0 20px rgba(0,255,65,0.15);
                                display: flex; flex-direction: column; backdrop-filter: blur(4px);">
                        <div
                            style="color:#FF0066; font-size:0.55rem; font-weight:bold; letter-spacing:1px; margin-bottom:4px; display:flex; justify-content:between;">
                            <span>üß† AGENT_THINKING_STREAM v4.2</span>
                            <span style="margin-left: auto;">[SYNCED_REALTIME]</span>
                        </div>
                        <div id="thought-log-container" style="flex:1; overflow-y:auto;">
                            <div style="color:rgba(0,255,65,0.5)">> Initializing transparency link...</div>
                        </div>
                    </div>
                </div>
                <div class="agent-viewer-sidebar">
                    <div class="viewer-info-panel">
                        <h3>üìä Live Metrics</h3>
                        <div class="viewer-stat">
                            <span class="stat-label">Current Focus:</span>
                            <span class="stat-value" id="viewer-task">Idle</span>
                        </div>
                        <!-- Dynamic Content Area based on Agent Type -->
                        <div id="viewer-dynamic-stats">
                            <div class="viewer-stat">
                                <span class="stat-label">Processing:</span>
                                <span class="stat-value" id="viewer-processing">Waiting...</span>
                            </div>
                            <div class="viewer-stat">
                                <span class="stat-label">Throughput:</span>
                                <span class="stat-value highlight" id="viewer-throughput">0 ops/s</span>
                            </div>
                        </div>
                    </div>
                    <div class="viewer-activity-panel">
                        <h3>üìù Agent Activity Log</h3>
                        <div class="viewer-activity-log" id="viewer-activity-log">
                            <div class="viewer-log-entry">Waiting for activity...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AZIREM Podcast Modal -->
    <div id="podcast-modal" class="podcast-modal hidden">
        <div class="podcast-backdrop" onclick="closePodcastPanel()"></div>
        <div class="podcast-container">
            <div class="podcast-header">
                <div class="podcast-title">
                    <span class="podcast-icon">üéôÔ∏è</span>
                    <h2>AZIREM Podcast</h2>
                    <span class="podcast-live-badge">LIVE</span>
                </div>
                <button class="podcast-close" onclick="closePodcastPanel()">√ó</button>
            </div>

            <div class="podcast-content">
                <!-- Audio Waveform Visualization -->
                <div class="podcast-waveform-container">
                    <canvas id="podcast-waveform" class="podcast-waveform"></canvas>
                    <div class="podcast-status" id="podcast-status">Idle</div>
                </div>

                <div class="podcast-transcript" id="podcast-transcript">
                    <div class="podcast-message azirem">
                        <div class="podcast-avatar">ü§ñ</div>
                        <div class="podcast-text">Welcome to the AZIREM Podcast! Ask me anything about your codebase,
                            AI, or let's just chat.</div>
                    </div>
                </div>

                <div class="podcast-input-area">
                    <button class="podcast-mic-btn" id="podcast-mic-btn" onclick="togglePodcastMic()"
                        title="Start/Stop Voice Capture">
                        <span id="mic-icon">üéôÔ∏è</span>
                    </button>
                    <input type="text" id="podcast-input" system_value="Ask AZIREM anything..."
                        onkeypress="if(event.key==='Enter') sendPodcastMessage()">
                    <button class="podcast-send" onclick="sendPodcastMessage()">
                        <span>üöÄ</span> Send
                    </button>
                    <label class="podcast-voice-toggle">
                        <input type="checkbox" id="podcast-voice-enabled" checked>
                        <span>üîä Voice Reply</span>
                    </label>
                </div>

            </div>

            <div class="podcast-agent-status" id="podcast-agent-status">
                <span class="agent-indicator idle">‚óè</span>
                <span id="podcast-status-text">Ready to chat</span>
            </div>
        </div>
    </div>

    <!-- Sovereign API Workbench Modal -->
    <div id="api-modal" class="api-modal hidden">
        <div class="api-backdrop" onclick="closeApiConsole()"></div>
        <div class="api-container">
            <div class="api-header">
                <div class="api-title">
                    <span>üõ†Ô∏è</span>
                    <h2>Sovereign API Workbench</h2>
                </div>
                <button class="viewer-close-btn" onclick="closeApiConsole()">‚úï</button>
            </div>
            <div class="api-body">
                <div class="api-sidebar" id="api-endpoints-list">
                    <!-- Endpoints will be populated here -->
                </div>
                <div class="api-main">
                    <div id="workbench-content">
                        <div class="workbench-section">
                            <h3 id="selected-endpoint-title">Select an endpoint to begin</h3>
                            <p id="selected-endpoint-desc" style="color:var(--text-secondary); margin-bottom:1.5rem;">
                                Use this workbench to interact directly with the Antigravity Sovereign API.
                            </p>

                            <div id="params-container" class="params-grid">
                                <!-- Parameters will be populated here -->
                            </div>
                        </div>

                        <button class="api-execute-btn" id="execute-api-btn" onclick="executeApiCall()">
                            üöÄ Execute Request
                        </button>

                        <div class="response-area">
                            <div class="response-header">
                                <span>Response Output</span>
                                <span id="response-status">Status: ---</span>
                            </div>
                            <pre id="response-body">/* Response will appear here after execution */</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* AZIREM Podcast Modal Styles */
        .podcast-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .podcast-modal.hidden {
            display: none;
        }

        .podcast-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
        }

        .podcast-container {
            position: relative;
            width: 90%;
            max-width: 800px;
            height: 80vh;
            max-height: 700px;
            background: linear-gradient(135deg, rgba(20, 0, 40, 0.95), rgba(10, 10, 30, 0.98));
            border: 1px solid rgba(255, 0, 170, 0.4);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 60px rgba(255, 0, 170, 0.3), inset 0 0 60px rgba(159, 79, 255, 0.1);
        }

        .podcast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 0, 170, 0.3);
        }

        .podcast-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .podcast-icon {
            font-size: 2rem;
            animation: podcastPulse 2s infinite;
        }

        @keyframes podcastPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .podcast-title h2 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-purple));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .podcast-live-badge {
            padding: 4px 10px;
            background: var(--neon-red);
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            border-radius: 4px;
            animation: livePulse 1.5s infinite;
        }

        @keyframes livePulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .podcast-close {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255, 79, 111, 0.2);
            color: var(--neon-red);
            font-size: 1.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .podcast-close:hover {
            background: var(--neon-red);
            color: white;
        }

        .podcast-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .podcast-waveform-container {
            position: relative;
            height: 120px;
            background: rgba(0, 255, 136, 0.05);
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .podcast-waveform {
            width: 100%;
            height: 100%;
        }

        .podcast-status {
            position: absolute;
            top: 10px;
            right: 20px;
            padding: 6px 16px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ff88;
            border-radius: 20px;
            font-size: 12px;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .podcast-status.thinking {
            background: rgba(255, 136, 0, 0.2);
            border-color: #ff8800;
            color: #ff8800;
            animation: pulse 1.5s infinite;
        }

        .podcast-status.speaking {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            color: #00ff88;
            animation: pulse 1s infinite;
        }

        .podcast-transcript {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .podcast-message {
            display: flex;
            gap: 12px;
            max-width: 85%;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .podcast-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .podcast-message.azirem {
            align-self: flex-start;
        }

        .podcast-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sharp);
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid var(--neon-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .podcast-message.user .podcast-avatar {
            background: rgba(0, 229, 255, 0.1);
            border-color: var(--neon-cyan);
        }

        .podcast-text {
            padding: 12px 16px;
            border-radius: var(--radius-subtle);
            background: #0d0d0d;
            border: 1px solid #222;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .podcast-message.user .podcast-text {
            border-color: var(--neon-cyan);
            background: rgba(0, 229, 255, 0.03);
        }

        .podcast-input-area {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid rgba(255, 0, 170, 0.2);
            background: rgba(0, 0, 0, 0.3);
        }

        .podcast-mic-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--neon-pink);
            background: rgba(255, 0, 170, 0.1);
            color: var(--neon-pink);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(255, 0, 170, 0.2);
        }

        .podcast-mic-btn.active {
            background: var(--neon-pink);
            color: white;
            box-shadow: 0 0 30px var(--neon-pink);
            animation: micPulse 1.5s infinite;
        }

        @keyframes micPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 15px var(--neon-pink);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0 40px var(--neon-pink);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 15px var(--neon-pink);
            }
        }


        #podcast-input {
            flex: 1;
            padding: 14px 18px;
            border-radius: var(--radius-sharp);
            border: 1px solid #333;
            background: #000;
            color: var(--text-bright);
            font-size: 1rem;
            font-family: var(--font-mono);
            outline: none;
            transition: border-color 0.2s;
        }

        #podcast-input:focus {
            border-color: var(--neon-green);
        }

        .podcast-send {
            padding: 14px 24px;
            border-radius: var(--radius-sharp);
            border: 1px solid var(--neon-green);
            background: rgba(0, 255, 65, 0.1);
            color: var(--neon-green);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .podcast-send:hover {
            background: var(--neon-green);
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
        }

        .podcast-voice-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            background: rgba(0, 255, 157, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 157, 0.3);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--neon-green);
        }

        .podcast-voice-toggle input {
            display: none;
        }

        .podcast-voice-toggle:has(input:checked) {
            background: rgba(0, 255, 157, 0.2);
        }

        .podcast-agent-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            border-top: 1px solid rgba(255, 0, 170, 0.15);
        }

        .agent-indicator {
            font-size: 0.8rem;
        }

        .agent-indicator.idle {
            color: var(--neon-green);
        }

        .agent-indicator.thinking {
            color: var(--neon-cyan);
            animation: blink 1s infinite;
        }

        .agent-indicator.speaking {
            color: var(--neon-orange);
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.3;
            }
        }

        /* Sovereign API Workbench Styles */
        .api-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10002;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .api-modal.hidden {
            display: none;
        }

        .api-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
        }

        .api-container {
            position: relative;
            width: 95vw;
            max-width: 1400px;
            height: 90vh;
            background: #020202;
            border: 1px solid #333;
            border-radius: var(--radius-sharp);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 100px rgba(0, 0, 0, 0.5);
        }

        .api-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0, 240, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 240, 255, 0.05);
        }

        .api-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--neon-cyan);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .api-body {
            flex: 1;
            display: grid;
            grid-template-columns: 350px 1fr;
            overflow: hidden;
        }

        .api-sidebar {
            border-right: 1px solid rgba(0, 240, 255, 0.1);
            overflow-y: auto;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
        }

        .api-main {
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            overflow-y: auto;
            background: rgba(10, 10, 25, 0.5);
        }

        .endpoint-group {
            margin-bottom: 1.5rem;
        }

        .endpoint-group-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
        }

        .endpoint-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border: 1px solid transparent;
        }

        .endpoint-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .endpoint-item.active {
            background: rgba(0, 240, 255, 0.1);
            border-color: rgba(0, 240, 255, 0.3);
            color: var(--neon-cyan);
        }

        .method-tag {
            font-size: 0.65rem;
            font-weight: 900;
            padding: 2px 6px;
            border-radius: 4px;
            min-width: 45px;
            text-align: center;
        }

        .method-tag.GET {
            background: rgba(0, 240, 255, 0.2);
            color: var(--neon-cyan);
        }

        .method-tag.POST {
            background: rgba(0, 255, 157, 0.2);
            color: var(--neon-green);
        }

        .method-tag.WS {
            background: rgba(159, 79, 255, 0.2);
            color: var(--neon-purple);
        }

        .workbench-section {
            margin-bottom: 2rem;
        }

        .workbench-section h3 {
            font-family: var(--font-display);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-bright);
        }

        .params-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.03);
            padding: 1rem;
            border-radius: 12px;
        }

        .param-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .param-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .param-input {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            border-radius: 6px;
            color: var(--text-primary);
            font-family: var(--font-mono);
            outline: none;
        }

        .param-input:focus {
            border-color: var(--neon-cyan);
        }

        .api-execute-btn {
            background: var(--gradient-sovereign);
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            font-family: var(--font-display);
            cursor: pointer;
            transition: all 0.3s;
            align-self: flex-start;
        }

        .api-execute-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.5);
        }

        .response-area {
            flex: 1;
            background: #000;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .response-header {
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        #response-body {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--neon-green);
            white-space: pre-wrap;
        }
    </style>

    <style>
        /* Agent Viewer Modal Styles */
        .agent-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .agent-viewer-modal.hidden {
            display: none;
        }

        .agent-viewer-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
        }

        .agent-viewer-container {
            position: relative;
            width: 90vw;
            max-width: 1400px;
            height: 85vh;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a102a 100%);
            border-radius: 20px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 0 60px rgba(139, 92, 246, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .agent-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.2), rgba(6, 182, 212, 0.2));
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .agent-viewer-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .agent-viewer-title span:first-child {
            font-size: 2rem;
        }

        .viewer-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            background: #00ff88;
            color: #000;
            border-radius: 20px;
            font-weight: 700;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            }

            50% {
                box-shadow: 0 0 25px rgba(0, 255, 136, 0.8);
            }
        }

        .viewer-close-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .viewer-close-btn:hover {
            background: rgba(255, 0, 0, 0.5);
            transform: rotate(90deg);
        }

        .viewer-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .viewer-capture-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .viewer-capture-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 212, 255, 0.6);
        }

        .viewer-capture-btn.active {
            background: linear-gradient(135deg, #ff4444, #ff8800);
            animation: pulse-capture 1.5s infinite;
        }

        /* Gesture Control Button */
        .viewer-gesture-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #00ff41, #00d4ff);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
        }

        .viewer-gesture-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 255, 65, 0.6);
        }

        .viewer-gesture-btn.active {
            background: linear-gradient(135deg, #ff00ff, #00ff41);
            color: #fff;
            animation: pulse-gesture 1.5s infinite;
        }

        @keyframes pulse-gesture {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
            }

            50% {
                box-shadow: 0 0 30px rgba(0, 255, 65, 0.8);
            }
        }

        /* Nexus Countdown Badge */
        .nexus-countdown-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 45, 85, 0.15);
            border: 1px solid #ff2d55;
            padding: 4px 10px;
            border-radius: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: #ff2d55;
            margin-left: 12px;
            animation: nexus-flicker 2s infinite ease-in-out;
        }

        .nexus-countdown-badge.hidden {
            display: none;
        }

        .nexus-pulse {
            width: 8px;
            height: 8px;
            background: #ff2d55;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff2d55;
            animation: nexus-pulse 1s infinite alternate;
        }

        @keyframes nexus-pulse {
            from {
                opacity: 0.4;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        @keyframes nexus-flicker {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* Gesture HUD */
        .gesture-hud {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid var(--neon-green);
            border-radius: 12px;
            padding: 1rem 2rem;
            z-index: 20;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.4);
        }

        .gesture-hud.hidden {
            display: none;
        }

        .gesture-indicator {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--neon-green);
            font-family: var(--font-display);
            letter-spacing: 2px;
        }

        .gesture-action {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Gesture Reference Panel */
        .gesture-reference {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--neon-cyan);
            border-radius: 8px;
            padding: 0.75rem;
            z-index: 20;
            font-size: 0.75rem;
        }

        .gesture-reference.hidden {
            display: none;
        }

        .gesture-ref-title {
            font-weight: 700;
            color: var(--neon-cyan);
            margin-bottom: 0.5rem;
            font-family: var(--font-display);
        }

        .gesture-ref-item {
            color: var(--text-secondary);
            padding: 0.15rem 0;
        }

        @keyframes pulse-capture {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
            }

            50% {
                box-shadow: 0 0 30px rgba(255, 136, 0, 0.8);
            }
        }

        .agent-viewer-body {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
        }

        .agent-viewer-video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #viewer-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .viewer-video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.7), transparent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .viewer-live-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.75rem;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            border-radius: 4px;
            font-weight: 700;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .viewer-agent-role {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
        }

        .agent-viewer-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }

        .viewer-info-panel,
        .viewer-activity-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .viewer-info-panel h3,
        .viewer-activity-panel h3 {
            margin: 0 0 1rem 0;
            font-size: 1rem;
            color: var(--neon-cyan);
        }

        .viewer-stat {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.6);
        }

        .stat-value {
            color: var(--neon-green);
            font-weight: 600;
        }

        .viewer-activity-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .viewer-activity-log {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
        }

        .viewer-log-entry {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
            border-left: 3px solid var(--neon-purple);
        }

        .viewer-log-entry.success {
            border-left-color: var(--neon-green);
        }

        .viewer-log-entry.warning {
            border-left-color: var(--neon-orange);
        }

        .viewer-log-entry.info {
            border-left-color: var(--neon-cyan);
        }

        /* Matrix Overlay Styles */
        .viewer-matrix-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 2rem;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.9rem;
            color: rgba(0, 255, 136, 0.8);
            text-shadow: 0 0 5px rgba(0, 255, 136, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.4) 50%, rgba(0, 0, 0, 0.9) 100%);
            pointer-events: none;
            overflow: hidden;
            z-index: 10;
        }

        .matrix-line {
            margin-bottom: 4px;
            opacity: 0;
            animation: matrix-fade-in 0.3s forwards;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .matrix-line.highlight {
            color: var(--neon-cyan);
            font-weight: bold;
        }

        .matrix-line.error {
            color: var(--neon-red);
        }

        @keyframes matrix-fade-in {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #viewer-dynamic-stats {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
    </style>
    <script>
        // SOVEREIGN MODAL CONTROLS
        function openOpikModal() {
            const modal = document.getElementById('sovereign-modal');
            const iframe = document.getElementById('opik-iframe');

            // Set source only when opening to enable lazy loading
            // Prefer 5174 (Frontend) but user fallback available in header
            if (!iframe.src || iframe.src === 'about:blank' || iframe.src === '') {
                iframe.src = "http://localhost:5173";
            }

            modal.classList.add('active');
        }

        function closeOpikModal() {
            const modal = document.getElementById('sovereign-modal');
            modal.classList.remove('active');
        }

        // Close on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('sovereign-modal').classList.contains('active')) {
                closeOpikModal();
            }
        });

        // ============================================
        // CONFIGURATION - REAL AGENT SYSTEM
        // ============================================
        const CONFIG = {
            API_BASE: window.location.origin,
            WS_URL: `ws://${window.location.host}/ws/stream`,
            REFRESH_INTERVAL: 3000,
            EVOLUTION_INTERVAL: 30000,
            AUTO_EVOLVE: false
        };

        // ============================================
        // STATE
        // ============================================
        let state = {
            connected: false,
            wsConnected: false,
            evolutionCycle: 0,
            autoEvolve: false,
            agents: [],
            activities: [],
            metrics: {
                patterns: 0,
                files: 0,
                knowledge: 0,
                agents: 13
            },
            patternDistribution: {},
            currentAgent: 'AZIREM',
            ws: null,
            chart: null
        };

        // ============================================
        // AGENT DEFINITIONS
        // ============================================
        // ============================================
        // AGENT DEFINITIONS (Fetched dynamically)
        // ============================================
        let AGENTS = [];

        async function fetchAgentsConfig() {
            try {
                const response = await fetch(CONFIG.API_BASE + '/api/agents/config');
                if (response.ok) {
                    const data = await response.json();
                    if (data.agents && data.agents.length > 0) {
                        AGENTS = data.agents;
                        renderAgents();
                        logTerminal(`‚úÖ Loaded ${AGENTS.length} agents from Sovereign Configuration`);
                    }
                }
            } catch (e) {
                console.error('Failed to fetch agent config:', e);
                // Fallback if fetch fails
                if (AGENTS.length === 0) {
                    AGENTS = [
                        { id: 'azirem', name: 'AZIREM', role: 'Master Orchestrator', status: 'active', icon: 'üëë' },
                        { id: 'bytebot', name: 'ByteBot', role: 'Visual Operator', status: 'active', icon: 'üëÄ' }
                    ];
                    renderAgents();
                }
            }
        }

        // Initialize Chart.js for Pattern Distribution
        function initializeChart() {
            const ctx = document.getElementById('patternChart');
            if (!ctx) return;

            state.chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Backend', 'Frontend', 'Agent', 'Util', 'Model'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#00ffff', '#ff00ff', '#ffff00', '#00ff00', '#ff0000']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initializeParticles();
            fetchAgentsConfig(); // Load agents from API
            renderAgents();
            startClock();
            initializeChart();
            connectWebSocket();
            tryConnect();
        });

        // Create floating particles
        function initializeParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 15) + 's';
                container.appendChild(particle);
            }
        }

        // Render agent cards
        function renderAgents() {
            const grid = document.getElementById('agent-grid');
            grid.innerHTML = AGENTS.map(agent => `
                <div class="agent-card ${agent.status === 'active' ? 'active' : ''}" 
                     onclick="selectAgent('${agent.id}')" id="agent-${agent.id}">
                    <div class="agent-avatar">
                        ${agent.status === 'active' ? '<div class="avatar-live-indicator"></div>' : ''}
                        ${agent.video ? `
                            <video class="agent-video" src="${agent.video}" autoplay loop muted playsinline></video>
                        ` : agent.icon}
                    </div>
                    <div class="agent-info">
                        <div class="agent-name">${agent.name}</div>
                        <div class="agent-role">${agent.role}</div>
                    </div>
                    <div class="agent-status ${agent.status}"></div>
                </div>
            `).join('');

            document.getElementById('active-agents-count').textContent =
                AGENTS.filter(a => a.status === 'active').length + ' Active';
        }

        // Start stream time clock
        function startClock() {
            let seconds = 0;
            setInterval(() => {
                seconds++;
                const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
                const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
                const s = String(seconds % 60).padStart(2, '0');
                document.getElementById('stream-time').textContent = `${h}:${m}:${s}`;
            }, 1000);
        }

        // ============================================
        // WEBSOCKET - REAL-TIME AGENT UPDATES
        // ============================================
        function connectWebSocket() {
            try {
                state.ws = new WebSocket(CONFIG.WS_URL);

                state.ws.onopen = () => {
                    state.wsConnected = true;
                    document.getElementById('connection-status').textContent = 'LIVE - Real Agents';
                    document.getElementById('main-status-dot').style.background = 'var(--neon-green)';
                    logTerminal('üîå WebSocket connected to REAL agent system!');
                    addActivity('üîå', '<span class="highlight">Connected</span> to real multi-agent backend');
                };

                state.ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    handleWebSocketMessage(msg);
                };

                state.ws.onclose = () => {
                    state.wsConnected = false;
                    document.getElementById('connection-status').textContent = 'Disconnected';
                    document.getElementById('main-status-dot').style.background = 'var(--neon-red)';
                    logTerminal('‚ùå WebSocket disconnected. Reconnecting in 3s...');
                    setTimeout(connectWebSocket, 3000);
                };

                state.ws.onerror = () => {
                    logTerminal('‚ö†Ô∏è WebSocket error. Running in simulation mode.');
                };

            } catch (e) {
                logTerminal('‚ö†Ô∏è Could not connect WebSocket. Running simulation.');
            }
        }

        function handleWebSocketMessage(message) {
            try {
                const type = message.type;
                const data = message.data;

                // 1. GLOBAL TERMINAL LOGGING (Optional debug)
                // console.log('WS:', type, data);

                // 2. AGENT VIEWER MULTIPLEXER (Update modal if open)
                if (window.currentViewerAgent) {
                    let viewerUpdateData = null;

                    if (type === 'agent_status' && data.agent_id === window.currentViewerAgent) {
                        viewerUpdateData = { status: data.status, type: 'status' };
                    }
                    else if (type === 'activity' && data.agent_name &&
                        AGENTS.find(a => a.name === data.agent_name)?.id === window.currentViewerAgent) {
                        viewerUpdateData = { message: data.message, type: 'info' };
                    }
                    else if (type === 'scan_progress' && window.currentViewerAgent === 'scanner') {
                        viewerUpdateData = {
                            message: `Scanned ${data.files_scanned} files (${data.percent}%)`,
                            type: 'dim'
                        };
                    }
                    else if (type === 'bytebot_vnc' && window.currentViewerAgent === 'bytebot') {
                        // Special handling for VNC
                    }

                    if (viewerUpdateData) {
                        updateViewerFromWebSocket(window.currentViewerAgent, viewerUpdateData);
                    }
                }

                // 3. MAIN DASHBOARD HANDLERS
                switch (type) {
                    case 'connected':
                        logTerminal(`‚úÖ ${data.message || 'Connected to Neural Grid'}`);
                        if (data.metrics) {
                            state.metrics = { ...state.metrics, ...data.metrics };
                            updateMetricsDisplay();
                        }
                        break;

                    case 'nexus_countdown':
                        const badge = document.getElementById('nexus-countdown-badge');
                        const timer = document.getElementById('nexus-timer');
                        if (badge && timer) {
                            badge.classList.remove('hidden');
                            const mins = Math.floor(data.remaining / 60);
                            const secs = data.remaining % 60;
                            timer.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                            if (data.remaining <= 0) badge.classList.add('hidden');
                        }
                        break;

                    case 'agent_status':
                        updateAgentStatus(data.agent_id, data.status);
                        break;

                    case 'activity':
                        addActivity(data.icon || 'üì°', `<span class="highlight">${data.agent_name}</span>: ${data.message}`);
                        logTerminal(`üì° ${data.agent_name}: ${data.message}`);
                        break;

                    case 'agent_thought':
                        addAgentThought(data);
                        break;

                    case 'scan_progress':
                        const phase = data.phase || 'scan'; // 'scan', 'learn', 'evolve'
                        const percent = data.percent || 0;
                        const bar = document.getElementById(`${phase}-bar`);
                        const label = document.getElementById(`${phase}-percent`);

                        if (bar && label) {
                            bar.style.width = `${percent}%`;
                            label.innerText = `${percent}%`;
                        }

                        if (percent === 100 && phase === 'evolve') {
                            state.evolutionCycle++;
                            document.getElementById('evolution-cycle').innerText = state.evolutionCycle;
                        }
                        break;

                    case 'feature_discovered':
                        if (data.feature) addKnowledgeNode(data.feature);
                        if (data.stats) updateStatsDisplay(data.stats);
                        if (state.chart && data.distribution) {
                            state.chart.data.datasets[0].data = Object.values(data.distribution);
                            state.chart.update('none');
                        }
                        break;

                    case 'evolution_stats':
                        logTerminal(`üß¨ Evolution: Coverage ${data.coverage}, ${data.components_generated} Modules Deployed`);
                        document.getElementById('evolution-cycle').innerText = data.iteration;
                        // Update coverage metrics if elements exist
                        const coverageEl = document.getElementById('coverage-val');
                        if (coverageEl) coverageEl.innerText = data.coverage;
                        break;

                    case 'asirem_state':
                        handleAsiremState(data);
                        break;

                    case 'speaking_started':
                        handleSpeakingStarted(data);
                        break;

                    case 'speaking_completed':
                        handleSpeakingCompleted(data);
                        break;

                    case 'bytebot_vnc':
                        const vnc = document.getElementById('bytebot-vnc');
                        if (data.vnc_url) {
                            vnc.innerHTML = `
                                <iframe 
                                    src="${data.vnc_url}" 
                                    style="width:100%; height:100%; border:none;"
                                    allow="clipboard-read; clipboard-write; autoplay"
                                ></iframe>
                            `;
                            logTerminal('üì° ByteBot VNC Stream connected');
                        }
                        break;

                    case 'podcast_response':
                        addPodcastMessage('azirem', data.response);
                        logTerminal(`ü§ñ AZIREM: ${data.response.substring(0, 80)}...`);
                        setPodcastStatus('idle', 'Ready to chat');
                        break;

                    case 'podcast_audio':
                        if (data.audio_path) {
                            setPodcastStatus('speaking', 'Speaking with your voice...');
                            logTerminal(`üîä Voice cloned audio: ${data.audio_path}`);
                            // In a real app we would play the audio blob here via an Audio object
                            // e.g. new Audio(data.audio_path).play();
                            setTimeout(() => setPodcastStatus('idle', 'Ready to chat'), 5000);
                        }
                        break;

                    case 'live_capture_update':
                        const img = document.getElementById('live-capture-img');
                        if (img && data.screenshot_url) {
                            img.src = data.screenshot_url;
                            img.style.display = 'block';
                            const badge = document.getElementById('viewer-live-badge');
                            if (badge) badge.style.display = 'block';
                        }
                        break;

                    case 'agent_stream_update':
                        if (data.stream_url) {
                            // If we were watching this agent, auto-update video?
                            // Logic to update AGENTS array
                            const ax = AGENTS.find(a => a.id === data.agent_id);
                            if (ax) ax.video = data.stream_url;
                            logTerminal(`üìπ ${data.agent_name}: Stream updated`);
                        }
                        break;

                    default:
                    // console.log('Unknown message type:', type);
                }

            } catch (e) {
                console.error('WebSocket Handler Error:', e);
            }
        }

        function updateAgentVideoStream(agentId, streamUrl, status) {
            const card = document.getElementById(`agent-${agentId}`);
            if (!card) return;

            const videoElement = card.querySelector('.agent-video');
            if (videoElement) {
                // ONLY update video source if it's a valid file path (not broken /stream/ URLs)
                if (streamUrl && (streamUrl.includes('/outputs/') || streamUrl.includes('/assets/'))) {
                    videoElement.src = streamUrl;
                    videoElement.load();
                    videoElement.play().catch(e => console.log('Video autoplay prevented:', e));
                } else if (!videoElement.currentSrc || videoElement.readyState === 0) {
                    // Fallback to default agent stream if no video is playing
                    const defaultPath = `/outputs/agent_streams/${agentId}/idle_stream.mp4`;
                    videoElement.src = defaultPath;
                    videoElement.load();
                    videoElement.play().catch(e => console.log('Video autoplay prevented:', e));
                }

                // Add pulsing effect during work
                if (status === 'working' || status === 'streaming') {
                    card.classList.add('active');
                    const avatar = card.querySelector('.agent-avatar');
                    if (avatar) {
                        avatar.style.animation = 'pulse 2s infinite';
                    }
                } else if (status === 'idle') {
                    card.classList.remove('active');
                    const avatar = card.querySelector('.agent-avatar');
                    if (avatar) {
                        avatar.style.animation = '';
                    }
                }
            }
        }

        function updateAgentStatus(agentId, status) {
            const card = document.getElementById(`agent-${agentId}`);
            if (card) {
                const statusDot = card.querySelector('.agent-status');
                statusDot.className = `agent-status ${status}`;

                // Update current agent display
                const agent = AGENTS.find(a => a.id === agentId);
                if (agent && status === 'thinking') {
                    document.getElementById('current-agent-name').textContent = agent.name;
                }
            }
        }

        async function updateMetricsDisplay() {
            document.getElementById('metric-patterns').textContent = state.metrics.patterns;
            document.getElementById('metric-files').textContent = state.metrics.files;
            document.getElementById('metric-knowledge').textContent = state.metrics.knowledge;
            document.getElementById('metric-agents').textContent = state.metrics.agents;
            document.getElementById('evolution-cycle').textContent = state.evolutionCycle;

            // Fetch pattern distribution for chart
            try {
                const response = await fetch(`${CONFIG.API_BASE}/api/patterns`);
                if (response.ok) {
                    const data = await response.json();
                    const sortedKeys = Object.keys(data.pattern_counts).sort((a, b) => data.pattern_counts[b] - data.pattern_counts[a]).slice(0, 10);

                    state.chart.data.labels = sortedKeys;
                    state.chart.data.datasets[0].data = sortedKeys.map(k => data.pattern_counts[k]);
                    state.chart.update('none'); // Update without animation for performance
                }
            } catch (e) {
                console.warn('Failed to fetch pattern data for chart');
            }
        }

        async function fetchAgents() {
            try {
                const response = await fetch(CONFIG.API_BASE + '/api/agents/config');
                if (response.ok) {
                    const data = await response.json();
                    if (data.agents && data.agents.length > 0) {
                        AGENTS = data.agents;
                        renderAgents();
                        logTerminal(`‚úÖ Loaded ${AGENTS.length} agents from backend configuration`);
                    } else {
                        // Fallback if empty
                        logTerminal('‚ö†Ô∏è No agents found in config, using minimal fallback');
                        renderAgents();
                    }
                }
            } catch (e) {
                logTerminal('‚ö†Ô∏è Failed to fetch agent config: ' + e.message);
                // Define minimal fallback if fetch fails completely
                AGENTS = [{ id: 'azirem', name: 'AZIREM (Offline)', role: 'Master', icon: 'üîå' }];
                renderAgents();
            }
        }

        async function fetchCredits() {
            try {
                const response = await fetch(CONFIG.API_BASE + '/api/veo3/credits');
                if (response.ok) {
                    veo3Credits = await response.json();
                    updateCreditsDisplay();
                    logTerminal('üíé Veo3 Credits synced with backend');
                }
            } catch (e) {
                console.error("Credit fetch failed", e);
            }
        }

        function updateChart(counts) {
            if (!state.chart || !counts) return;

            // Sort by count and take top 8
            const sortedKeys = Object.keys(counts).sort((a, b) => counts[b] - counts[a]).slice(0, 10);

            state.chart.data.labels = sortedKeys;
            state.chart.data.datasets[0].data = sortedKeys.map(k => counts[k]);
            state.chart.update('none'); // Update without animation for performance
        }

        function addKnowledgeNodeReal(topic) {
            const container = document.getElementById('knowledge-nodes');

            // Check if already exists
            if (container.textContent.includes(topic)) return;

            const node = document.createElement('div');
            node.className = 'knowledge-node';
            node.textContent = topic;
            node.style.animation = 'slideIn 0.3s ease';
            container.appendChild(node);

            // Update count
            const count = container.children.length;
            document.getElementById('knowledge-count').textContent = count + ' nodes';
        }

        // ============================================
        // ACTIVITY STREAM
        // ============================================
        function addActivity(icon, text) {
            const stream = document.getElementById('activity-stream');
            const now = new Date();
            const time = now.toLocaleTimeString();

            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
                <div class="activity-icon">${icon}</div>
                <div class="activity-content">
                    <div class="activity-text">${text}</div>
                    <div class="activity-time">${time}</div>
                </div>
            `;

            stream.insertBefore(item, stream.firstChild);

            // Keep only last 30
            while (stream.children.length > 30) {
                stream.removeChild(stream.lastChild);
            }

            // Update count
            document.getElementById('activity-count').textContent = stream.children.length + ' events';
        }

        function logTerminal(message) {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = 'terminal-line';
            line.innerHTML = `
                <span class="terminal-prompt">$</span>
                <span class="terminal-text">${message}</span>
            `;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;

            // Keep last 100 lines
            while (terminal.children.length > 100) {
                terminal.removeChild(terminal.firstChild);
            }
        }

        // ============================================
        // AGENT SELECTION & FULL-SCREEN VIEWER
        // ============================================
        let currentViewerAgent = null;
        let viewerActivityBuffer = {};

        // Matrix Overlay Logic
        function addMatrixLine(text, type = 'normal') {
            const matrix = document.getElementById('viewer-matrix');
            if (!matrix) return;

            const line = document.createElement('div');
            line.className = `matrix-line ${type === 'highlight' ? 'highlight' : ''} ${type === 'error' ? 'error' : ''}`;

            // Add timestamp prefix
            const ts = new Date().toISOString().split('T')[1].split('.')[0];
            line.textContent = `[${ts}] ${text}`;

            matrix.appendChild(line);

            // Keep only last 15 lines in overlay
            while (matrix.children.length > 15) {
                matrix.removeChild(matrix.firstChild);
            }
        }

        function selectAgent(agentId) {
            document.querySelectorAll('.agent-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById(`agent-${agentId}`).classList.add('active');

            const agent = AGENTS.find(a => a.id === agentId);
            document.getElementById('current-agent-name').textContent = agent.name;

            addActivity(agent.icon, `Switched to <span class="highlight">${agent.name}</span> agent`);

            // Open full-screen viewer for this agent
            openAgentViewer(agentId);
        }

        function openAgentViewer(agentId) {
            const agent = AGENTS.find(a => a.id === agentId);
            if (!agent) return;

            currentViewerAgent = agentId;

            // Initialize activity buffer for this agent if not exists
            if (!viewerActivityBuffer[agentId]) {
                viewerActivityBuffer[agentId] = [];
            }

            // Update modal header (with defensive null checks)
            const iconEl = document.getElementById('viewer-agent-icon');
            const nameEl = document.getElementById('viewer-agent-name');
            const roleEl = document.getElementById('viewer-role');

            if (iconEl) iconEl.textContent = agent.icon;
            if (nameEl) nameEl.textContent = agent.name;
            if (roleEl) roleEl.textContent = agent.role;

            // Load agent video stream OR VNC stream for ByteBot
            const visualSlot = document.getElementById('viewer-visual-slot');

            // Special handling for ByteBot - show live VNC stream
            if (agentId === 'bytebot') {
                if (visualSlot) {
                    // Replace main visual with VNC iframe
                    visualSlot.innerHTML = `
                        <iframe 
                            id="viewer-vnc-iframe"
                            src="http://localhost:9990/novnc/vnc.html?host=localhost&port=9990&path=websockify&resize=scale&autoconnect=true"
                            style="width:100%; height:100%; border:none; background:#000;"
                            allow="clipboard-read; clipboard-write"
                        ></iframe>
                    `;
                    addMatrixLine(`CONNECTING TO BYTEBOT LIVE DESKTOP...`, 'highlight');
                    addMatrixLine(`VNC STREAM: localhost:9990`);
                    addMatrixLine(`UBUNTU LINUX ENVIRONMENT READY`);
                }
            } else {
                // Standard video stream for other agents
                if (visualSlot) {
                    // Restore original elements if they were replaced by iframe
                    visualSlot.innerHTML = `
                        <canvas id="agent-canvas" width="960" height="540"></canvas>
                        <video id="viewer-video" autoplay muted loop
                            style="width:100%; height:100%; object-fit:contain; background:#000; position:absolute; top:0; left:0; z-index:1;">
                        </video>
                        <img id="live-capture-img"
                            style="display:none; width:100%; height:100%; object-fit:contain; position:absolute; top:0; left:0; z-index:5;" />
                    `;
                }

                const videoEl = document.getElementById('viewer-video');
                const videoPath = `/outputs/agent_streams/${agentId}/idle_stream.mp4`;
                if (videoEl) {
                    videoEl.src = videoPath;
                    videoEl.load();
                    videoEl.play().catch(e => console.log('Viewer video autoplay prevented:', e));
                } else {
                    console.warn('viewer-video element not found');
                }
            }

            // Clear Matrix Overlay
            const matrix = document.getElementById('viewer-matrix');
            if (matrix) matrix.innerHTML = '';
            // We need to define addMatrixLine before using it, or call it safely
            if (typeof addMatrixLine === 'function') {
                addMatrixLine(`INITIALIZING ${agent.name.toUpperCase()} CORE...`, 'highlight');
                addMatrixLine(`CONNECTING TO SECURE VISUAL FEED...`);
            }

            // Setup Dynamic Stats Layout based on Agent ID
            const dynamicContainer = document.getElementById('viewer-dynamic-stats');
            if (dynamicContainer) {
                if (agentId === 'scanner') {
                    dynamicContainer.innerHTML = `
                        <div class="viewer-stat"><span class="stat-label">Scan Path:</span><span class="stat-value" id="viewer-d-1">Waiting...</span></div>
                        <div class="viewer-stat"><span class="stat-label">File Type:</span><span class="stat-value highlight" id="viewer-d-2">...</span></div>
                        <div class="viewer-stat"><span class="stat-label">Scan Rate:</span><span class="stat-value" id="viewer-throughput">...</span></div>
                    `;
                } else if (agentId === 'researcher') {
                    dynamicContainer.innerHTML = `
                        <div class="viewer-stat"><span class="stat-label">Query:</span><span class="stat-value" id="viewer-d-1">Waiting...</span></div>
                        <div class="viewer-stat"><span class="stat-label">Source:</span><span class="stat-value highlight" id="viewer-d-2">...</span></div>
                        <div class="viewer-stat"><span class="stat-label">Depth:</span><span class="stat-value" id="viewer-throughput">...</span></div>
                    `;
                } else {
                    // Default Layout
                    dynamicContainer.innerHTML = `
                        <div class="viewer-stat"><span class="stat-label">Operation:</span><span class="stat-value" id="viewer-d-1">Waiting...</span></div>
                        <div class="viewer-stat"><span class="stat-label">Object:</span><span class="stat-value highlight" id="viewer-d-2">...</span></div>
                        <div class="viewer-stat"><span class="stat-label">Load:</span><span class="stat-value" id="viewer-throughput">...</span></div>
                    `;
                }
            }

            // Set initial status
            const taskEl = document.getElementById('viewer-task');
            if (taskEl) taskEl.textContent = agent.status === 'active' ? 'Working' : 'Idle';

            // Load buffered activity for this agent
            renderViewerActivity(agentId);

            // Show modal
            const modal = document.getElementById('agent-viewer-modal');
            if (modal) modal.classList.remove('hidden');

            logTerminal(`üëÅÔ∏è Opened High-Fidelity Cockpit for ${agent.name}`);
        }

        // Track live capture state
        let isLiveCaptureActive = false;

        function toggleLiveCapture() {
            const btn = document.getElementById('live-capture-btn');
            const badge = document.getElementById('viewer-live-badge');
            const liveImg = document.getElementById('live-capture-img');

            if (!currentViewerAgent) return;

            isLiveCaptureActive = !isLiveCaptureActive;

            if (isLiveCaptureActive) {
                // Start live capture
                if (btn) {
                    btn.classList.add('active');
                    btn.innerHTML = 'üî¥ Stop Capture';
                }
                if (badge) {
                    badge.innerHTML = 'üé¨ SCREEN CAPTURE ACTIVE';
                    badge.style.background = 'linear-gradient(135deg, #ff4444, #ff8800)';
                }

                if (liveImg) {
                    liveImg.style.display = 'block';
                }

                // Send WebSocket message to start capture
                if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                    state.ws.send(JSON.stringify({
                        type: 'start_live_capture',
                        agent_id: currentViewerAgent
                    }));
                }

                if (typeof addMatrixLine === 'function') {
                    addMatrixLine('ACTIVATING SCREEN CAPTURE - OpenAI Operator Mode', 'highlight');
                }
                logTerminal(`üé¨ Live screen capture started for ${currentViewerAgent}`);
            } else {
                // Stop live capture
                if (btn) {
                    btn.classList.remove('active');
                    btn.innerHTML = 'üé¨ Start Live Capture';
                }
                if (badge) {
                    badge.innerHTML = '‚óè LIVE ACTIVITY';
                    badge.style.background = '';
                }

                if (liveImg) {
                    liveImg.style.display = 'none';
                }

                // Send WebSocket message to stop capture
                if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                    state.ws.send(JSON.stringify({
                        type: 'stop_live_capture',
                        agent_id: currentViewerAgent
                    }));
                }

                if (typeof addMatrixLine === 'function') {
                    addMatrixLine('SCREEN CAPTURE STOPPED', '');
                }
                logTerminal(`üõë Live screen capture stopped for ${currentViewerAgent}`);
            }
        }

        // ============ GESTURE CONTROL SYSTEM ============
        let isGestureControlActive = false;
        let gestureWs = null;
        let gestureOverlayCtx = null;

        const GESTURE_ICONS = {
            'none': '‚ùì',
            'point': 'üëÜ',
            'pinch': 'ü§è',
            'grab': '‚úä',
            'open_palm': '‚úã',
            'swipe_left': 'üëà',
            'swipe_right': 'üëâ',
            'swipe_up': '‚¨ÜÔ∏è',
            'swipe_down': '‚¨áÔ∏è',
            'spread': 'ü§≤',
            'peace': '‚úåÔ∏è'
        };

        const GESTURE_ACTIONS = {
            'none': 'No gesture detected',
            'point': 'Controlling cursor',
            'pinch': 'Click',
            'grab': 'Dragging',
            'open_palm': 'Stopped',
            'swipe_left': 'Navigate back',
            'swipe_right': 'Navigate forward',
            'swipe_up': 'Scrolling up',
            'swipe_down': 'Scrolling down',
            'spread': 'Zooming in',
            'peace': 'Right-click'
        };

        let gestureStream = null; // Store webcam stream for cleanup

        async function toggleGestureControl() {
            const btn = document.getElementById('gesture-control-btn');
            const hud = document.getElementById('gesture-hud');
            const reference = document.getElementById('gesture-reference');
            const overlay = document.getElementById('gesture-overlay-canvas');
            const webcamVideo = document.getElementById('gesture-webcam-video');

            isGestureControlActive = !isGestureControlActive;

            if (isGestureControlActive) {
                // Start gesture control
                btn.classList.add('active');
                btn.innerHTML = 'üñêÔ∏è Stop Gestures';
                hud.classList.remove('hidden');
                reference.classList.remove('hidden');
                overlay.style.display = 'block';

                // Start webcam feed in browser
                try {
                    gestureStream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 1280, height: 720, facingMode: 'user' }
                    });
                    webcamVideo.srcObject = gestureStream;
                    webcamVideo.style.display = 'block';
                    logTerminal('üì∑ Webcam activated - you should see yourself!');
                } catch (e) {
                    console.error('Webcam access denied:', e);
                    logTerminal('‚ùå Webcam access denied - please allow camera access');
                    // Revert state
                    isGestureControlActive = false;
                    btn.classList.remove('active');
                    btn.innerHTML = 'üñêÔ∏è Enable Gestures';
                    hud.classList.add('hidden');
                    reference.classList.add('hidden');
                    overlay.style.display = 'none';
                    return;
                }

                // Initialize canvas context
                if (!gestureOverlayCtx) {
                    overlay.width = overlay.offsetWidth;
                    overlay.height = overlay.offsetHeight;
                    gestureOverlayCtx = overlay.getContext('2d');
                }

                // Start gesture detection via API (backend webcam)
                try {
                    const response = await fetch('/api/gesture/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ performance_mode: false })
                    });
                    const data = await response.json();
                    logTerminal(`üñêÔ∏è ${data.message || 'Gesture control activated!'}`);
                } catch (e) {
                    console.error('Failed to start gesture control:', e);
                    logTerminal('‚ö†Ô∏è Backend gesture processing unavailable - webcam preview only');
                }

                // Connect to gesture WebSocket
                connectGestureWebSocket();

                // AUTO-SWITCH TO BYTEBOT MODE IF VIEWING BYTEBOT
                if (currentViewerAgent === 'bytebot') {
                    setGestureMode('bytebot');
                    logTerminal('üöÄ GESTURE: Auto-switching to BYTEBOT target mode.');
                }

                // Initialize client-side MediaPipe Hands for real-time visualization
                setTimeout(() => {
                    initMediaPipeHands().catch(e => {
                        console.error('MediaPipe Hands init failed:', e);
                        logTerminal('‚ö†Ô∏è Client-side hand tracking unavailable');
                    });
                }, 500); // Wait for video to be ready

                if (typeof addMatrixLine === 'function') {
                    addMatrixLine('GESTURE CONTROL ACTIVATED - Minority Report Mode', 'highlight');
                }
            } else {
                // Stop gesture control
                btn.classList.remove('active');
                btn.innerHTML = 'üñêÔ∏è Enable Gestures';
                hud.classList.add('hidden');
                reference.classList.add('hidden');
                overlay.style.display = 'none';

                // Stop webcam feed
                if (gestureStream) {
                    gestureStream.getTracks().forEach(track => track.stop());
                    gestureStream = null;
                }
                webcamVideo.style.display = 'none';
                webcamVideo.srcObject = null;

                // Stop gesture detection
                try {
                    await fetch('/api/gesture/stop', { method: 'POST' });
                } catch (e) {
                    console.error('Failed to stop gesture control:', e);
                }

                // Disconnect WebSocket
                if (gestureWs) {
                    gestureWs.close();
                    gestureWs = null;
                }

                // Clear canvas
                if (gestureOverlayCtx) {
                    gestureOverlayCtx.clearRect(0, 0, overlay.width, overlay.height);
                }

                if (typeof addMatrixLine === 'function') {
                    addMatrixLine('GESTURE CONTROL STOPPED', '');
                }
                logTerminal('üõë Gesture control stopped');
            }
        }

        // ============ CLIENT-SIDE MEDIAPIPE HANDS ============
        let mediaPipeHands = null;
        let mediaPipeCamera = null;

        async function initMediaPipeHands() {
            const webcamVideo = document.getElementById('gesture-webcam-video');
            const overlay = document.getElementById('gesture-overlay-canvas');

            // Set canvas size to match video
            overlay.width = webcamVideo.videoWidth || 1280;
            overlay.height = webcamVideo.videoHeight || 720;
            gestureOverlayCtx = overlay.getContext('2d');

            // Initialize MediaPipe Hands
            mediaPipeHands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });

            mediaPipeHands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.7,
                minTrackingConfidence: 0.5
            });

            mediaPipeHands.onResults(onHandsResults);

            // Start camera loop
            mediaPipeCamera = new Camera(webcamVideo, {
                onFrame: async () => {
                    if (isGestureControlActive && mediaPipeHands) {
                        await mediaPipeHands.send({ image: webcamVideo });
                    }
                },
                width: 1280,
                height: 720
            });

            await mediaPipeCamera.start();
            logTerminal('üñêÔ∏è MediaPipe Hands initialized - move your hand!');
        }

        function onHandsResults(results) {
            const overlay = document.getElementById('gesture-overlay-canvas');
            const ctx = gestureOverlayCtx;
            if (!ctx || !overlay) return;

            // Clear canvas
            ctx.clearRect(0, 0, overlay.width, overlay.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                for (const landmarks of results.multiHandLandmarks) {
                    // Draw connections (skeleton)
                    drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {
                        color: '#00FF41',
                        lineWidth: 3
                    });
                    // Draw landmarks (dots)
                    drawLandmarks(ctx, landmarks, {
                        color: '#00D4FF',
                        lineWidth: 1,
                        radius: 4
                    });
                }

                // Classify gesture and update HUD
                const gesture = classifyGestureClient(results.multiHandLandmarks[0]);
                updateGestureHUD(gesture);
            } else {
                // No hand detected
                updateGestureHUD('none');
            }
        }

        function classifyGestureClient(landmarks) {
            // Simple gesture classification
            const thumbTip = landmarks[4];
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const ringTip = landmarks[16];
            const pinkyTip = landmarks[20];
            const wrist = landmarks[0];

            // Calculate finger extended states
            const indexUp = indexTip.y < landmarks[6].y;
            const middleUp = middleTip.y < landmarks[10].y;
            const ringUp = ringTip.y < landmarks[14].y;
            const pinkyUp = pinkyTip.y < landmarks[18].y;

            // Pinch detection (thumb and index close)
            const pinchDist = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
            if (pinchDist < 0.05) return 'pinch';

            // Peace sign
            if (indexUp && middleUp && !ringUp && !pinkyUp) return 'peace';

            // Point (only index up)
            if (indexUp && !middleUp && !ringUp && !pinkyUp) return 'point';

            // Open palm (all fingers up)
            if (indexUp && middleUp && ringUp && pinkyUp) return 'open_palm';

            // Fist (no fingers up)
            if (!indexUp && !middleUp && !ringUp && !pinkyUp) return 'grab';

            return 'none';
        }

        function updateGestureHUD(gesture) {
            const indicator = document.getElementById('gesture-indicator');
            const action = document.getElementById('gesture-action');
            if (indicator && action) {
                indicator.innerHTML = `${GESTURE_ICONS[gesture] || '‚ùì'} ${gesture.toUpperCase().replace('_', ' ')}`;
                action.textContent = GESTURE_ACTIONS[gesture] || 'Move your hand';
            }
        }


        function connectGestureWebSocket() {
            const wsUrl = `ws://${window.location.host}/ws/gestures`;
            gestureWs = new WebSocket(wsUrl);

            gestureWs.onopen = () => {
                console.log('üñêÔ∏è Gesture WebSocket connected');
            };

            gestureWs.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'gesture_update') {
                        updateGestureUI(msg.data);
                    }
                } catch (e) {
                    console.error('Gesture WS parse error:', e);
                }
            };

            gestureWs.onerror = (error) => {
                console.error('Gesture WebSocket error:', error);
            };

            gestureWs.onclose = () => {
                console.log('üñêÔ∏è Gesture WebSocket closed');
            };
        }

        function updateGestureUI(data) {
            const indicator = document.getElementById('gesture-indicator');
            const action = document.getElementById('gesture-action');
            const overlay = document.getElementById('gesture-overlay-canvas');

            if (!indicator || !action) return;

            // Update HUD
            const gesture = data.gesture || 'none';
            indicator.innerHTML = `${GESTURE_ICONS[gesture] || '‚ùì'} ${gesture.toUpperCase().replace('_', ' ')}`;
            action.textContent = GESTURE_ACTIONS[gesture] || 'Unknown';

            // Draw hand landmarks on overlay
            if (gestureOverlayCtx && data.landmarks && data.landmarks.length > 0) {
                const ctx = gestureOverlayCtx;
                ctx.clearRect(0, 0, overlay.width, overlay.height);

                // Draw landmarks
                ctx.fillStyle = '#00ff41';
                ctx.strokeStyle = '#00d4ff';
                ctx.lineWidth = 2;

                // Draw connections
                const connections = [
                    [0, 1], [1, 2], [2, 3], [3, 4],       // Thumb
                    [0, 5], [5, 6], [6, 7], [7, 8],       // Index
                    [0, 9], [9, 10], [10, 11], [11, 12],  // Middle
                    [0, 13], [13, 14], [14, 15], [15, 16],// Ring
                    [0, 17], [17, 18], [18, 19], [19, 20],// Pinky
                    [5, 9], [9, 13], [13, 17]             // Palm
                ];

                ctx.beginPath();
                connections.forEach(([a, b]) => {
                    if (data.landmarks[a] && data.landmarks[b]) {
                        const ax = (1 - data.landmarks[a].x) * overlay.width;
                        const ay = data.landmarks[a].y * overlay.height;
                        const bx = (1 - data.landmarks[b].x) * overlay.width;
                        const by = data.landmarks[b].y * overlay.height;
                        ctx.moveTo(ax, ay);
                        ctx.lineTo(bx, by);
                    }
                });
                ctx.stroke();

                // Draw landmarks as dots
                data.landmarks.forEach((lm, i) => {
                    const x = (1 - lm.x) * overlay.width;
                    const y = lm.y * overlay.height;
                    ctx.beginPath();
                    ctx.arc(x, y, i === 0 ? 8 : 5, 0, Math.PI * 2);
                    ctx.fill();
                });
            }
        }


        function closeAgentViewer() {
            // Stop live capture if active
            if (isLiveCaptureActive) {
                toggleLiveCapture();
            }

            const modal = document.getElementById('agent-viewer-modal');
            if (modal) modal.classList.add('hidden');
            const video = document.getElementById('viewer-video');
            if (video) video.pause();
            currentViewerAgent = null;
        }

        function addViewerActivity(agentId, message, type = 'info') {
            // Store in buffer
            if (!viewerActivityBuffer[agentId]) {
                viewerActivityBuffer[agentId] = [];
            }
            viewerActivityBuffer[agentId].push({ message, type, time: new Date() });

            // Keep only last 50 entries
            if (viewerActivityBuffer[agentId].length > 50) {
                viewerActivityBuffer[agentId].shift();
            }

            // If viewer is open for this agent, update in real-time
            if (currentViewerAgent === agentId) {
                renderViewerActivity(agentId);
            }
        }

        function renderViewerActivity(agentId) {
            const log = document.getElementById('viewer-activity-log');
            const activities = viewerActivityBuffer[agentId] || [];

            if (activities.length === 0) {
                log.innerHTML = '<div class="viewer-log-entry">Waiting for activity...</div>';
                return;
            }

            log.innerHTML = activities.slice(-20).reverse().map(a => {
                const time = a.time.toLocaleTimeString();
                return `<div class="viewer-log-entry ${a.type}">[${time}] ${a.message}</div>`;
            }).join('');
        }

        // Update viewer when agent status changes via WebSocket
        function updateViewerFromWebSocket(agentId, data) {
            // Always buffer global activity
            if (data.message) {
                addViewerActivity(agentId, data.message, data.type || 'info');
            }

            // Only update UI if this agent is currently being viewed
            if (currentViewerAgent === agentId) {

                // 1. Matrix Log Injection
                if (data.message) {
                    if (typeof addMatrixLine === 'function') addMatrixLine(data.message.toUpperCase(), data.type === 'error' ? 'error' : 'normal');
                }
                if (data.current_file) {
                    if (typeof addMatrixLine === 'function') addMatrixLine(`PROCESSING: ${data.current_file}`, 'highlight');
                }

                // 2. Dynamic Stats Injection
                const stat1 = document.getElementById('viewer-d-1');
                const stat2 = document.getElementById('viewer-d-2');
                const throughput = document.getElementById('viewer-throughput');

                if (agentId === 'scanner' && data.current_file && stat1) {
                    const parts = data.current_file.split('/');
                    const filename = parts[parts.length - 1];
                    const ext = filename.includes('.') ? filename.split('.').pop().toUpperCase() : 'FILE';

                    stat1.textContent = '...' + filename.substring(0, 20);
                    if (stat2) stat2.textContent = ext;

                    // Show real throughput if available, otherwise waiting
                    if (data.rate) {
                        if (throughput) throughput.textContent = `${data.rate}`;
                    } else {
                        if (throughput) throughput.textContent = 'Calculating...';
                    }
                }
                else if (agentId === 'researcher' && data.current_url && stat1) {
                    stat1.textContent = 'Web Search';
                    try {
                        if (stat2) stat2.textContent = new URL(data.current_url).hostname;
                    } catch (e) { if (stat2) stat2.textContent = 'Unknown Source'; }
                }

                // 3. Status Display
                if (data.status) {
                    document.getElementById('viewer-task').textContent = data.status.toUpperCase();
                    document.getElementById('viewer-status').textContent = data.status === 'idle' ? 'IDLE' : 'LIVE';
                }

                // 4. Update video if new stream URL (with optimization check)
                if (data.stream_url && (data.stream_url.includes('/outputs/') || data.stream_url.includes('/assets/'))) {
                    const video = document.getElementById('viewer-video');
                    // Only update if actually different to avoid flicker
                    if (video.getAttribute('src') !== data.stream_url) {
                        video.src = data.stream_url;
                        video.load();
                        video.play().catch(e => console.log('Viewer switch prevented:', e));
                    }
                }
            }
        }

        // Handle ESC key to close viewer
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && currentViewerAgent) {
                closeAgentViewer();
            }
        });

        // ============================================
        // ACTIONS - REAL AGENT COMMANDS (NO SIMULATION)
        // ============================================
        function triggerEvolutionCycle() {
            addActivity('üîÑ', `<span class="highlight">REAL Evolution Cycle</span> triggered - scanning your repos!`);
            logTerminal('üß¨ Triggering REAL evolution cycle...');

            // Send command to real backend (WebSocket preferred, fallback to REST)
            if (state.wsConnected && state.ws) {
                state.ws.send(JSON.stringify({ type: 'run_pipeline' }));
                logTerminal('üì° Pipeline request sent via WebSocket');
            } else {
                // Fallback to REST API (still real, not simulated)
                fetch(CONFIG.API_BASE + '/api/run-pipeline', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => logTerminal('üì° Pipeline started via REST API'))
                    .catch(e => {
                        logTerminal('‚ùå Backend offline - cannot run pipeline.');
                        addActivity('‚ùå', '<span class="highlight">ERROR</span>: Backend not available.');
                    });
            }
        }

        // =========================================================================
        // AGENT ACTION DISPATCHER FUNCTIONS
        // =========================================================================

        async function agentAction_AziremCode() {
            const filepath = prompt('Enter file path to create:', '/nas/yacine/aSiReM/demo_module.py');
            if (!filepath) return;
            const content = '#!/usr/bin/env python3\n"""Expert Code by AZIREM"""\nprint("Actuating on ByteBot mesh...")\n';

            addActivity('üëë', `<span class="highlight">AZIREM</span>: Creating expert code on ByteBot...`);
            logTerminal(`üëë AZIREM: Actuating physical code creation: ${filepath}`);

            if (state.wsConnected && state.ws) {
                state.ws.send(JSON.stringify({
                    type: 'agent_create_code',
                    filepath,
                    content
                }));
            }
        }

        async function agentAction_BumblebeeResearch() {
            const query = prompt('Enter research query:', 'latest AI agent patterns 2026');
            if (!query) return;

            addActivity('üêù', `<span class="highlight">BUMBLEBEE</span>: Deep-researching global mesh...`);
            logTerminal(`üêù BUMBLEBEE: Actuating web search: ${query}`);

            if (state.wsConnected && state.ws) {
                state.ws.send(JSON.stringify({
                    type: 'agent_research',
                    query
                }));
            }
        }

        async function agentAction_ScannerExplore() {
            const path = prompt('Enter directory to explore:', '/nas/yacine/aSiReM');
            if (!path) return;

            addActivity('üì°', `<span class="highlight">SCANNER</span>: Actuating physical disk exploration...`);
            logTerminal(`üì° SCANNER: Opening Thunar inside ByteBot at ${path}`);

            if (state.wsConnected && state.ws) {
                state.ws.send(JSON.stringify({
                    type: 'agent_explore',
                    path
                }));
            }
        }

        async function agentAction_SpectraPreview() {
            const url = prompt('Enter URL to preview:', 'http://localhost:8082');
            if (!url) return;

            addActivity('üåà', `<span class="highlight">SPECTRA</span>: Actuating visual preview...`);
            logTerminal(`üåà SPECTRA: Rendering target URL in ByteBot Firefox: ${url}`);

            if (state.wsConnected && state.ws) {
                state.ws.send(JSON.stringify({
                    type: 'agent_preview',
                    url
                }));
            }
        }

        async function openAgentActionLog() {
            try {
                const response = await fetch(CONFIG.API_BASE + '/api/agent/action-log');
                const data = await response.json();

                let logHtml = '<h3>üéØ Agent Action Log</h3>';
                logHtml += `<p>Total actions: ${data.actions?.length || 0}</p>`;
                logHtml += '<table style="width:100%;font-size:0.7rem;"><tr><th>Agent</th><th>Action</th><th>Success</th><th>Duration</th></tr>';

                (data.actions || []).slice(-10).forEach(action => {
                    logHtml += `<tr>
                        <td>${action.agent_id}</td>
                        <td>${action.action}</td>
                        <td>${action.success ? '‚úÖ' : '‚ùå'}</td>
                        <td>${action.duration_ms}ms</td>
                    </tr>`;
                });
                logHtml += '</table>';

                showModal('AGENT_ACTION_LOG', logHtml);
            } catch (e) {
                logTerminal(`‚ùå Failed to load action log: ${e.message}`);
            }
        }

        /**
         * aSiReM Avatar Handlers
         */
        function handleAsiremState(data) {
            if (window.asiremAvatar) {
                window.asiremAvatar.setState(data.state);
                if (data.message) {
                    window.asiremAvatar.speak(data.message);
                }
            }
        }

        function handleSpeakingStarted(data) {
            const avatar = document.getElementById('asirem-avatar-img');
            if (avatar) avatar.classList.add('speaking');

            if (data.text || data.message) {
                showAsiremBubble(data.text || data.message);
            }
        }

        function handleSpeakingCompleted(data) {
            const avatar = document.getElementById('asirem-avatar-img');
            if (avatar) avatar.classList.remove('speaking');

            setTimeout(() => {
                const bubble = document.getElementById('asirem-speech-bubble');
                if (bubble) bubble.classList.add('hidden');
            }, 5000);
        }

        function showAsiremBubble(text) {
            const bubble = document.getElementById('asirem-speech-bubble');
            const content = document.getElementById('asirem-speech-text');
            if (!bubble || !content) return;

            content.textContent = text;
            bubble.classList.remove('hidden');
        }

        async function asiremSpeak() {
            const message = prompt('What should aSiReM say?');
            if (!message) return;

            try {
                await fetch(CONFIG.API_BASE + '/api/asirem/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
            } catch (e) {
                logTerminal(`‚ùå Speaking failed: ${e.message}`);
            }
        }

        /**
         * Gesture Mode Toggle
         */

        // =========================================================================
        // PER-AGENT VIDEO RECORDING FUNCTIONS
        // =========================================================================

        let currentRecordingAgent = null;

        async function startAgentRecording() {
            const agentId = prompt('Enter agent ID to record:', 'azirem');
            if (!agentId) return;

            addActivity('üé¨', `<span class="highlight">RECORDING</span> starting for ${agentId}...`);
            logTerminal(`üé¨ Starting recording for ${agentId}...`);

            try {
                const response = await fetch(CONFIG.API_BASE + '/api/recording/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ agent_id: agentId, agent_name: agentId.toUpperCase() })
                });
                const data = await response.json();

                if (data.success) {
                    currentRecordingAgent = agentId;
                    document.getElementById('rec-start-btn').disabled = true;
                    document.getElementById('rec-start-btn').style.opacity = '0.5';
                    document.getElementById('rec-stop-btn').disabled = false;
                    document.getElementById('rec-stop-btn').style.color = '#FF0066';
                    document.getElementById('rec-status').textContent = `Recording ${agentId}...`;
                    document.getElementById('rec-status').style.color = '#FF0066';

                    logTerminal(`‚úÖ Recording started: ${data.recording?.output_path}`);
                    addActivity('‚è∫Ô∏è', `<span class="highlight">RECORDING</span> ${agentId} - capturing actions...`);
                } else {
                    logTerminal(`‚ùå Failed to start recording: ${data.error}`);
                }
            } catch (e) {
                logTerminal(`‚ùå Recording error: ${e.message}`);
            }
        }

        async function stopAgentRecording() {
            if (!currentRecordingAgent) {
                logTerminal('‚ö†Ô∏è No active recording to stop');
                return;
            }

            addActivity('‚èπÔ∏è', `<span class="highlight">RECORDING</span> stopping ${currentRecordingAgent}...`);

            try {
                const response = await fetch(CONFIG.API_BASE + '/api/recording/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ agent_id: currentRecordingAgent })
                });
                const data = await response.json();

                if (data.success) {
                    const recording = data.recording;
                    document.getElementById('rec-start-btn').disabled = false;
                    document.getElementById('rec-start-btn').style.opacity = '1';
                    document.getElementById('rec-stop-btn').disabled = true;
                    document.getElementById('rec-stop-btn').style.color = '#888';
                    document.getElementById('rec-status').textContent = `Saved: ${recording.duration_seconds?.toFixed(1)}s`;
                    document.getElementById('rec-status').style.color = '#00FF41';

                    logTerminal(`‚úÖ Recording stopped: ${recording.duration_seconds?.toFixed(1)}s, ${(recording.file_size_bytes / 1024).toFixed(1)}KB`);
                    addActivity('üíæ', `<span class="highlight">SAVED</span> ${currentRecordingAgent} recording`);

                    currentRecordingAgent = null;
                } else {
                    logTerminal(`‚ùå Failed to stop recording: ${data.error}`);
                }
            } catch (e) {
                logTerminal(`‚ùå Recording stop error: ${e.message}`);
            }
        }

        // =========================================================================
        // GESTURE MODE SWITCHING (Local macOS vs ByteBot Ubuntu)
        // =========================================================================

        let currentGestureMode = 'local';

        async function setGestureMode(mode) {
            addActivity('üéØ', `<span class="highlight">GESTURE MODE</span> switching to ${mode.toUpperCase()}...`);
            logTerminal(`üéØ Switching gesture target to ${mode}...`);

            try {
                const response = await fetch(CONFIG.API_BASE + '/api/gesture/mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
                const data = await response.json();

                if (data.mode) {
                    currentGestureMode = mode;
                    const localBtn = document.getElementById('mode-local-btn');
                    const bytebotBtn = document.getElementById('mode-bytebot-btn');
                    const statusEl = document.getElementById('gesture-mode-status');

                    if (mode === 'bytebot') {
                        // Highlight ByteBot button
                        localBtn.style.background = 'rgba(0, 255, 65, 0.1)';
                        localBtn.style.border = '1px solid rgba(0, 255, 65, 0.4)';
                        bytebotBtn.style.background = 'rgba(255, 0, 102, 0.25)';
                        bytebotBtn.style.border = '2px solid #FF0066';
                        statusEl.textContent = 'Mode: BYTEBOT üê≥';
                        statusEl.style.color = '#FF0066';

                        logTerminal(`‚úÖ ByteBot mode active - controlling Ubuntu desktop!`);
                        addActivity('üê≥', `<span class="highlight">BYTEBOT</span> Hand gestures now control virtual Ubuntu!`);
                    } else {
                        // Highlight Local button
                        localBtn.style.background = 'rgba(0, 255, 65, 0.25)';
                        localBtn.style.border = '2px solid #00FF41';
                        bytebotBtn.style.background = 'rgba(255, 0, 102, 0.1)';
                        bytebotBtn.style.border = '1px solid rgba(255, 0, 102, 0.4)';
                        statusEl.textContent = 'Mode: LOCAL üñ•Ô∏è';
                        statusEl.style.color = '#00FF41';

                        logTerminal(`‚úÖ Local mode active - controlling macOS desktop!`);
                        addActivity('üñ•Ô∏è', `<span class="highlight">LOCAL</span> Hand gestures now control macOS!`);
                    }
                } else {
                    logTerminal(`‚ùå Mode switch failed: ${data.error}`);
                    if (mode === 'bytebot' && data.error?.includes('not available')) {
                        addActivity('‚ö†Ô∏è', `ByteBot container not running - start it first!`);
                    }
                }
            } catch (e) {
                logTerminal(`‚ùå Gesture mode error: ${e.message}`);
            }
        }

        let autoEvolveInterval = null;

        function toggleAutoEvolve() {
            state.autoEvolve = !state.autoEvolve;
            const label = document.getElementById('auto-evolve-label');

            if (state.autoEvolve) {
                label.textContent = 'Auto-Evolve: ON';
                label.style.color = 'var(--neon-green)';
                autoEvolveInterval = setInterval(triggerEvolutionCycle, CONFIG.EVOLUTION_INTERVAL);
                addActivity('üîÅ', '<span class="highlight">Auto-Evolution</span> enabled - REAL scanning!');
            } else {
                label.textContent = 'Auto-Evolve: OFF';
                label.style.color = '';
                clearInterval(autoEvolveInterval);
                addActivity('‚èπÔ∏è', '<span class="highlight">Auto-Evolution</span> disabled');
            }
        }

        function searchWeb() {
            addActivity('üåê', '<span class="highlight">Web Search</span> initiated for cutting-edge patterns');
            logTerminal('üîç Searching web for 2026 AI agent patterns...');

            // Send to real backend only
            if (state.wsConnected && state.ws) {
                state.ws.send(JSON.stringify({
                    type: 'web_search',
                    query: 'AI multi-agent systems 2026 cutting edge patterns'
                }));
                logTerminal('üì° Web search request sent via WebSocket');
            } else {
                fetch(CONFIG.API_BASE + '/api/web-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: 'AI agents 2026' })
                })
                    .then(r => r.json())
                    .then(data => logTerminal('üåê Web search started via REST API'))
                    .catch(e => {
                        logTerminal('‚ùå Backend offline - cannot perform web search');
                        addActivity('‚ùå', '<span class="highlight">ERROR</span>: Backend not available for web search');
                    });
            }
        }

        // ============================================
        // VIDEO CONTROLS
        // ============================================
        function toggleMute() {
            const video = document.getElementById('video-player');
            video.muted = !video.muted;
        }

        function togglePlay() {
            const video = document.getElementById('video-player');
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        }

        function toggleFullscreen() {
            const panel = document.querySelector('.video-panel');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                panel.requestFullscreen();
            }
        }

        // ============================================
        // API CONNECTION
        // ============================================
        async function tryConnect() {
            try {
                const response = await fetch(CONFIG.API_BASE + '/api/status');
                if (response.ok) {
                    const data = await response.json();
                    state.connected = true;
                    logTerminal('‚úÖ Connected to REAL Agent System API');
                    logTerminal(`üìä Mode: ${data.mode || 'REAL_AGENTS'}`);

                    // Fetch dynamic agent config
                    fetchAgentsConfig();

                    // Update metrics from API
                    if (data.metrics) {
                        state.metrics = {
                            patterns: data.metrics.patterns_discovered || 0,
                            files: data.metrics.files_scanned || 0,
                            knowledge: data.metrics.knowledge_items || 0,
                            agents: data.metrics.agents_spawned || 13
                        };
                        updateMetricsDisplay();
                    }
                }
            } catch (e) {
                state.connected = false;
                logTerminal('‚ö†Ô∏è API offline - WebSocket may still work');
            }
        }

        // ============================================
        // aSiReM SPEAKING & VEO3 INTEGRATION
        // ============================================

        // Veo3 credit tracking (Ultra Plan: 12,500 credits/month)
        let veo3Credits = {
            total: 12500,
            used: 0,
            fastCost: 20,
            qualityCost: 100
        };

        function getRemainingVideos(quality = 'fast') {
            const remaining = veo3Credits.total - veo3Credits.used;
            return Math.floor(remaining / (quality === 'fast' ? veo3Credits.fastCost : veo3Credits.qualityCost));
        }

        function updateCreditsDisplay() {
            const display = document.getElementById('credits-display');
            if (display) {
                display.textContent = `~${getRemainingVideos('fast')} videos left`;
            }
        }

        function asiremSpeak() {
            const topics = ['greeting', 'what is AI', 'how I work', 'the future of AI'];
            const topic = topics[Math.floor(Math.random() * topics.length)];

            addActivity('üó£Ô∏è', `<span class="highlight">aSiReM</span> preparing to speak about: ${topic}`);
            logTerminal(`üé§ Initializing speaking pipeline...`);
            logTerminal(`üìù Topic: ${topic}`);

            // Send to real backend only - no simulation
            if (state.wsConnected && state.ws) {
                state.ws.send(JSON.stringify({
                    type: 'asirem_speak',
                    topic: topic
                }));
                logTerminal('üì° Request sent to speaking engine - awaiting real response...');
            } else {
                logTerminal('‚ùå Backend not connected - cannot run speaking pipeline');
                addActivity('‚ùå', '<span class="highlight">ERROR</span>: Backend not available. Run real_agent_system.py');
            }
        }

        function generateVeo3() {
            const scenes = [
                'aSiReM standing in magical garden, looking curious',
                'aSiReM walking through neon-lit city streets',
                'aSiReM teaching at a holographic chalkboard',
                'aSiReM flying through clouds with blue bird companion'
            ];
            const scene = scenes[Math.floor(Math.random() * scenes.length)];

            addActivity('üé¨', `<span class="highlight">Veo3</span> generating video: "${scene.substring(0, 40)}..."`);
            logTerminal('üé¨ Veo3 Video Generation Started');
            logTerminal(`üìù Prompt: ${scene}`);
            logTerminal('‚è±Ô∏è Duration: 8 seconds | Quality: Fast (20 credits)');

            // Send to real backend only - no simulation
            if (state.wsConnected && state.ws) {
                // Deduct credits only when sending real request
                veo3Credits.used += veo3Credits.fastCost;
                updateCreditsDisplay();

                state.ws.send(JSON.stringify({
                    type: 'veo3_generate',
                    prompt: scene,
                    duration: 8,
                    quality: 'fast'
                }));
                logTerminal('üì° Veo3 generation request sent - awaiting real response...');
            } else {
                logTerminal('‚ùå Backend not connected - cannot generate video');
                addActivity('‚ùå', '<span class="highlight">ERROR</span>: Backend not available for Veo3 generation');
            }
        }

        function generateNarrative() {
            const topic = "The Sovereignty of Cold Azirem";

            addActivity('üé≠', `<span class="highlight">Cinematic Narrative</span> started! Topic: ${topic}`);
            logTerminal('üé≠ Cinematic Narrative Production Initiated');
            logTerminal(`üìù Topic: ${topic}`);
            logTerminal('üé¨ Orchestrating multi-expert production team...');

            // Send to real backend only - no simulation
            if (state.wsConnected && state.ws) {
                state.ws.send(JSON.stringify({
                    type: 'veo3_narrative',
                    topic: topic
                }));
                logTerminal('üì° Narrative production request sent - awaiting real response...');
            } else {
                logTerminal('‚ùå Backend not connected - cannot produce narrative');
                addActivity('‚ùå', '<span class="highlight">ERROR</span>: Backend not available for narrative production');
            }
        }

        function showCredits() {
            const remaining = veo3Credits.total - veo3Credits.used;
            const fastVideos = getRemainingVideos('fast');
            const qualityVideos = getRemainingVideos('quality');

            addActivity('üíé', `<span class="highlight">Veo3 Credits</span>: ${remaining} / ${veo3Credits.total}`);
            logTerminal('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            logTerminal('üíé VEO3 CREDIT STATUS (Ultra Plan)');
            logTerminal('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            logTerminal(`   Total Credits: ${veo3Credits.total}`);
            logTerminal(`   Used Credits:  ${veo3Credits.used}`);
            logTerminal(`   Remaining:     ${remaining}`);
            logTerminal('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            logTerminal(`   üöÄ Fast Videos (20 cr):    ~${fastVideos} remaining`);
            logTerminal(`   ‚ú® Quality Videos (100 cr): ~${qualityVideos} remaining`);
            logTerminal('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        }

        // ============================================
        // AZIREM PODCAST FUNCTIONS
        // ============================================

        // Waveform instance
        let podcastWaveform = null;

        function openPodcastPanel() {
            const modal = document.getElementById('podcast-modal');
            modal.classList.remove('hidden');
            document.getElementById('podcast-input').focus();
            addActivity('üéôÔ∏è', '<span class="highlight">AZIREM Podcast</span> session started');
            logTerminal('üéôÔ∏è AZIREM Podcast session opened');

            // Initialize waveform if not already done
            if (!podcastWaveform) {
                // Load waveform script
                const script = document.createElement('script');
                script.src = 'audio_waveform.js';
                script.onload = () => {
                    podcastWaveform = new AudioWaveform('podcast-waveform');
                    podcastWaveform.setColors('#00ff88', 'rgba(0, 0, 0, 0.1)');
                    updatePodcastStatus('idle');
                };
                document.head.appendChild(script);
            }
        }

        function updatePodcastStatus(status) {
            const statusEl = document.getElementById('podcast-status');
            statusEl.className = 'podcast-status';

            switch (status) {
                case 'thinking':
                    statusEl.textContent = 'Thinking...';
                    statusEl.classList.add('thinking');
                    break;
                case 'speaking':
                    statusEl.textContent = 'Speaking';
                    statusEl.classList.add('speaking');
                    break;
                case 'idle':
                default:
                    statusEl.textContent = 'Idle';
                    break;
            }
        }

        function closePodcastPanel() {
            const modal = document.getElementById('podcast-modal');
            modal.classList.add('hidden');
        }

        function setPodcastStatus(status, text) {
            const indicator = document.querySelector('#podcast-agent-status .agent-indicator');
            const statusText = document.getElementById('podcast-status-text');

            indicator.className = `agent-indicator ${status}`;
            statusText.textContent = text;
        }

        function addPodcastMessage(type, text) {
            const transcript = document.getElementById('podcast-transcript');
            const avatar = type === 'user' ? 'üßë' : 'ü§ñ';

            const message = document.createElement('div');
            message.className = `podcast-message ${type}`;
            message.innerHTML = `
                <div class="podcast-avatar">${avatar}</div>
                <div class="podcast-text">${text}</div>
            `;

            transcript.appendChild(message);
            transcript.scrollTop = transcript.scrollHeight;
        }

        // Microphone Logic
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        async function togglePodcastMic() {
            const btn = document.getElementById('podcast-mic-btn');

            if (!isRecording) {
                // Start Recording
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = sendAudioToServer;

                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('active');
                    setPodcastStatus('listening', 'Listening to you...');
                    logTerminal("üé§ Microphone activated");

                    // Visual feedback
                    document.getElementById('mic-icon').textContent = '‚èπÔ∏è';

                } catch (err) {
                    console.error("Error accessing microphone:", err);
                    logTerminal("‚ùå Microphone access denied: " + err.message);
                    setPodcastStatus('idle', 'Mic Error');
                }
            } else {
                // Stop Recording
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('active');
                setPodcastStatus('thinking', 'Processing audio...');
                document.getElementById('mic-icon').textContent = 'üéôÔ∏è';

                // Stop all tracks
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }

        async function sendAudioToServer() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

            // Create FormData
            const formData = new FormData();
            formData.append('audio', audioBlob);

            logTerminal("üì§ Sending audio to AZIREM Brain...");

            // Visual feedback: Thinking
            setPodcastStatus('thinking', 'Thinking...');
            if (window.asiremAvatar) window.asiremAvatar.setState('analyzing');

            try {
                const response = await fetch('/api/podcast/audio', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.transcription) {
                    addPodcastMessage('user', data.transcription);
                    logTerminal(`üé§ You said: "${data.transcription}"`);
                }

                if (data.response) {
                    addPodcastMessage('azirem', data.response);
                    logTerminal(`ü§ñ AZIREM: ${data.response}`);

                    // Speak via Avatar Bubble
                    if (window.asiremAvatar) window.asiremAvatar.speak(data.response);

                    if (data.audio_base64) {
                        playAudioResponse(data.audio_base64);
                    } else if (data.audio_path) {
                        // Play from path
                        const audio = new Audio(data.audio_path);
                        setPodcastStatus('speaking', 'Speaking...');
                        if (window.asiremAvatar) {
                            window.asiremAvatar.setState('commanding');
                            document.querySelector('.asirem-avatar-overlay').classList.add('speaking');
                        }

                        audio.onended = () => {
                            setPodcastStatus('idle', 'Ready');
                            if (window.asiremAvatar) window.asiremAvatar.setState('idle');
                            document.querySelector('.asirem-avatar-overlay').classList.remove('speaking');
                        };
                        audio.play();
                    } else {
                        // No audio, just reset state
                        setPodcastStatus('idle', 'Ready');
                        if (window.asiremAvatar) window.asiremAvatar.setState('idle');
                    }
                } else {
                    setPodcastStatus('idle', 'Ready');
                    if (window.asiremAvatar) window.asiremAvatar.setState('idle');
                }

            } catch (err) {
                console.error("Error sending audio:", err);
                logTerminal("‚ùå Error processing audio");
                setPodcastStatus('idle', 'Error');
                if (window.asiremAvatar) window.asiremAvatar.setState('idle');
            }
        }

        function playAudioResponse(base64Audio) {
            const audio = new Audio("data:audio/wav;base64," + base64Audio);
            setPodcastStatus('speaking', 'Speaking...');

            if (window.asiremAvatar) {
                window.asiremAvatar.setState('commanding');
                // Trigger visual waves if bound to class
                const overlay = document.querySelector('.asirem-avatar-overlay');
                if (overlay) overlay.classList.add('speaking');
            }

            audio.onended = () => {
                setPodcastStatus('idle', 'Ready');
                if (window.asiremAvatar) window.asiremAvatar.setState('idle');
                const overlay = document.querySelector('.asirem-avatar-overlay');
                if (overlay) overlay.classList.remove('speaking');
            };
            audio.play();
        }

        async function sendPodcastMessage() {
            const input = document.getElementById('podcast-input');
            const question = input.value.trim();

            if (!question) return;

            // Add user message
            addPodcastMessage('user', question);
            input.value = '';

            // Visual feedback
            setPodcastStatus('thinking', 'Thinking...');
            if (window.asiremAvatar) window.asiremAvatar.setState('analyzing');

            try {
                const response = await fetch('/api/podcast/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        use_voice: true  // Request audio response
                    })
                });

                const data = await response.json();

                if (data.response) {
                    addPodcastMessage('azirem', data.response);

                    if (window.asiremAvatar) window.asiremAvatar.speak(data.response);

                    if (data.audio_base64) {
                        playAudioResponse(data.audio_base64);
                    } else if (data.audio_path) {
                        // Play path
                        const audio = new Audio(data.audio_path);
                        setPodcastStatus('speaking', 'Speaking...');
                        if (window.asiremAvatar) {
                            window.asiremAvatar.setState('commanding');
                            document.querySelector('.asirem-avatar-overlay').classList.add('speaking');
                        }
                        audio.onended = () => {
                            setPodcastStatus('idle', 'Ready');
                            if (window.asiremAvatar) window.asiremAvatar.setState('idle');
                            document.querySelector('.asirem-avatar-overlay').classList.remove('speaking');
                        };
                        audio.play();
                    } else {
                        setPodcastStatus('idle', 'Ready');
                        if (window.asiremAvatar) window.asiremAvatar.setState('idle');
                    }
                } else {
                    setPodcastStatus('idle', 'Ready');
                    if (window.asiremAvatar) window.asiremAvatar.setState('idle');
                }

            } catch (err) {
                console.error("Error sending message:", err);
                setPodcastStatus('idle', 'Error');
                if (window.asiremAvatar) window.asiremAvatar.setState('idle');
            }
        }



        // Global Nucleus state
        let nucleus = {
            scene: null,
            camera: null,
            renderer: null,
            points: null,
            lines: null,
            frameId: null,
            agents: 1176,
            initialized: false
        };

        function setVideoMode(mode) {
            const player = document.getElementById('video-player');
            const vnc = document.getElementById('bytebot-vnc');
            const nucleusEl = document.getElementById('nucleus-3d');

            const tabAgent = document.getElementById('tab-agent');
            const tabBytebot = document.getElementById('tab-bytebot');
            const tabNucleus = document.getElementById('tab-nucleus');

            // Reset displays
            player.style.display = 'none';
            vnc.style.display = 'none';
            nucleusEl.style.display = 'none';

            tabAgent.classList.remove('active');
            tabBytebot.classList.remove('active');
            tabNucleus.classList.remove('active');

            if (mode === 'bytebot') {
                vnc.style.display = 'block';
                tabBytebot.classList.add('active');
                if (state.wsConnected && state.ws) {
                    state.ws.send(JSON.stringify({ type: 'get_bytebot_vnc' }));
                }
                logTerminal('ü§ñ Switched to ByteBot Control Center');
            } else if (mode === 'nucleus') {
                nucleusEl.style.display = 'block';
                tabNucleus.classList.add('active');
                if (!nucleus.initialized) initNucleus();
                loadNucleusData();
                logTerminal('üåå Sovereign Nucleus: 3D Mesh Topology Active');
            } else {
                player.style.display = 'block';
                tabAgent.classList.add('active');
                logTerminal('üëÅÔ∏è Switched to Multi-Agent Visual Stream');
            }
        }

        function initNucleus() {
            const container = document.getElementById('nucleus-3d');
            const width = container.clientWidth;
            const height = container.clientHeight;

            nucleus.scene = new THREE.Scene();
            nucleus.camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            nucleus.camera.position.z = 200;

            nucleus.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            nucleus.renderer.setSize(width, height);
            nucleus.renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(nucleus.renderer.domElement);

            // Create 1176 agents as particles
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(nucleus.agents * 3);
            const colors = new Float32Array(nucleus.agents * 3);

            for (let i = 0; i < nucleus.agents; i++) {
                // Spherical distribution
                const r = 100 + Math.random() * 20;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);

                positions[i * 3] = r * Math.sin(phi) * Math.cos(theta);
                positions[i * 3 + 1] = r * Math.sin(phi) * Math.sin(theta);
                positions[i * 3 + 2] = r * Math.cos(phi);

                // Tech colors
                colors[i * 3] = 0; // R
                colors[i * 3 + 1] = 1; // G
                colors[i * 3 + 2] = 0.6; // B
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 1.5,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });

            nucleus.points = new THREE.Points(geometry, material);
            nucleus.scene.add(nucleus.points);

            // Connect nearby agents with lines (Mesh clusters)
            const lineGeometry = new THREE.BufferGeometry();
            const linePositions = [];
            for (let i = 0; i < 200; i++) {
                const idx1 = Math.floor(Math.random() * nucleus.agents);
                const idx2 = Math.floor(Math.random() * nucleus.agents);
                linePositions.push(positions[idx1 * 3], positions[idx1 * 3 + 1], positions[idx1 * 3 + 2]);
                linePositions.push(positions[idx2 * 3], positions[idx2 * 3 + 1], positions[idx2 * 3 + 2]);
            }
            lineGeometry.setAttribute('position', new THREE.BufferAttribute(new Float32Array(linePositions), 3));
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x00d2ff, transparent: true, opacity: 0.2 });
            nucleus.lines = new THREE.LineSegments(lineGeometry, lineMaterial);
            nucleus.scene.add(nucleus.lines);

            nucleus.initialized = true;
            animateNucleus();

            // Resize handler
            window.addEventListener('resize', () => {
                if (nucleus.renderer) {
                    const w = container.clientWidth;
                    const h = container.clientHeight;
                    nucleus.camera.aspect = w / h;
                    nucleus.camera.updateProjectionMatrix();
                    nucleus.renderer.setSize(w, h);
                }
            });
        }

        function animateNucleus() {
            nucleus.frameId = requestAnimationFrame(animateNucleus);

            nucleus.points.rotation.y += 0.001;
            nucleus.points.rotation.x += 0.0005;
            nucleus.lines.rotation.y += 0.001;
            nucleus.lines.rotation.x += 0.0005;

            // Pulsing effect
            const time = Date.now() * 0.001;
            nucleus.points.material.size = 1.5 + Math.sin(time * 2) * 0.5;

            nucleus.renderer.render(nucleus.scene, nucleus.camera);
        }

        async function loadNucleusData() {
            try {
                const response = await fetch('/api/patterns');
                const data = await response.json();

                if (data.knowledge_graph && Object.keys(data.knowledge_graph).length > 0) {
                    logTerminal(`üåå Nucleus: Loading ${Object.keys(data.knowledge_graph).length} knowledge nodes...`);
                    updateNucleusGeometry(data.knowledge_graph);
                } else {
                    logTerminal('üåå Nucleus: No knowledge graph data yet. Running synthetic mesh.');
                }
            } catch (e) {
                console.error("Nucleus load error:", e);
            }
        }

        function updateNucleusGeometry(graph) {
            // Convert graph to points
            const nodes = Object.values(graph);
            const count = nodes.length;
            if (count === 0) return;

            const positions = new Float32Array(count * 3);
            const colors = new Float32Array(count * 3);

            nodes.forEach((node, i) => {
                // Random spherical distribution for now, spread out
                const r = 80 + Math.random() * 40;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);

                positions[i * 3] = r * Math.sin(phi) * Math.cos(theta);
                positions[i * 3 + 1] = r * Math.sin(phi) * Math.sin(theta);
                positions[i * 3 + 2] = r * Math.cos(phi);

                // Color by type
                if (node.type === 'agent') { colors[i * 3] = 0; colors[i * 3 + 1] = 1; colors[i * 3 + 2] = 0; } // Green
                else if (node.type === 'concept') { colors[i * 3] = 0; colors[i * 3 + 1] = 0.8; colors[i * 3 + 2] = 1; } // Cyan
                else { colors[i * 3] = 1; colors[i * 3 + 1] = 0; colors[i * 3 + 2] = 0.5; } // Red/Pink
            });

            // Update Points
            nucleus.points.geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            nucleus.points.geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            nucleus.points.geometry.attributes.position.needsUpdate = true;
            nucleus.points.geometry.attributes.color.needsUpdate = true;

            // Create connecting lines based on relationships
            // Start fresh lines
            nucleus.scene.remove(nucleus.lines);

            const linePositions = [];
            // Connect some nodes randomly for visual effect if no explicit edges
            // In a real graph we'd follow node.edges
            for (let i = 0; i < Math.min(count * 2, 500); i++) {
                const idx1 = Math.floor(Math.random() * count);
                const idx2 = Math.floor(Math.random() * count);
                linePositions.push(positions[idx1 * 3], positions[idx1 * 3 + 1], positions[idx1 * 3 + 2]);
                linePositions.push(positions[idx2 * 3], positions[idx2 * 3 + 1], positions[idx2 * 3 + 2]);
            }

            const lineGeometry = new THREE.BufferGeometry();
            lineGeometry.setAttribute('position', new THREE.BufferAttribute(new Float32Array(linePositions), 3));
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x00ff9d, transparent: true, opacity: 0.15 });
            nucleus.lines = new THREE.LineSegments(lineGeometry, lineMaterial);
            nucleus.scene.add(nucleus.lines);
        }

        // ============================================
        // SOVEREIGN API WORKBENCH (API CONSOLE)
        // ============================================

        const API_ENDPOINTS = {
            // Sovereign Agent Mesh
            'mesh-query': { path: '/api/mesh/query', method: 'POST', desc: 'Execute a system-wide audit via the 1176-agent mesh.', params: [{ name: 'query', type: 'text', default: 'Identify all UI/Backend disconnects in index.html and real_agent_system.py' }] },

            // Core & Orchestration
            'status': { path: '/api/status', method: 'GET', desc: 'Get system status and metrics.', params: [] },
            'run-pipeline': { path: '/api/run-pipeline', method: 'POST', desc: 'Trigger the full multi-agent pipeline.', params: [] },
            'evolution': { path: '/api/evolution', method: 'POST', desc: 'Trigger the evolution agent separately.', params: [] },
            'web-search': { path: '/api/web-search', method: 'POST', desc: 'Perform a web search using Perplexity/DuckDuckGo.', params: [{ name: 'query', type: 'text', default: 'AI multi-agent systems 2026' }] },
            'discoveries': { path: '/api/discoveries', method: 'GET', desc: 'List all discovered patterns.', params: [] },
            'patterns': { path: '/api/patterns', method: 'GET', desc: 'Get pattern statistics.', params: [] },

            // Extended Agents
            'memory-store': { path: '/api/memory/store', method: 'POST', desc: 'Store data in Memory Agent.', params: [{ name: 'key', type: 'text' }, { name: 'value', type: 'text' }] },
            'memory-search': { path: '/api/memory/search', method: 'GET', desc: 'Search Memory Agent.', params: [{ name: 'query', type: 'text' }] },
            'embedding-index': { path: '/api/embedding/index', method: 'POST', desc: 'Semantically index content.', params: [{ name: 'text', type: 'text' }, { name: 'metadata', type: 'text', default: '{}' }] },
            'embedding-search': { path: '/api/embedding/search', method: 'GET', desc: 'Perform semantic search.', params: [{ name: 'query', type: 'text' }, { name: 'limit', type: 'number', default: 5 }] },
            'docgen-readme': { path: '/api/docgen/readme', method: 'POST', desc: 'Generate README for a path.', params: [{ name: 'path', type: 'text' }] },
            'docgen-api': { path: '/api/docgen/api', method: 'POST', desc: 'Generate API docs for a file.', params: [{ name: 'path', type: 'text' }] },
            'mcp-github': { path: '/api/mcp/github', method: 'POST', desc: 'Call GitHub MCP tool.', params: [{ name: 'tool', type: 'text' }, { name: 'params', type: 'text', default: '{}' }] },
            'mcp-perplexity': { path: '/api/mcp/perplexity', method: 'POST', desc: 'Call Perplexity MCP tool.', params: [{ name: 'query', type: 'text' }] },
            'agents-extended': { path: '/api/agents/extended', method: 'GET', desc: 'Get status of all extended agents.', params: [] },

            // Video Generation
            'veo3-credits': { path: '/api/veo3/credits', method: 'GET', desc: 'Check Veo3 credits.', params: [] },
            'veo3-generate': { path: '/api/veo3/generate', method: 'POST', desc: 'Generate video with Veo3.', params: [{ name: 'prompt', type: 'text' }, { name: 'duration', type: 'number', default: 8 }] },

            // Communication
            'agents-all': { path: '/api/agents/all', method: 'GET', desc: 'List all active agents.', params: [] },
            'agents-comms': { path: '/api/agents/communications', method: 'GET', desc: 'Get agent chat history.', params: [{ name: 'limit', type: 'number', default: 50 }] },
            'agents-message': { path: '/api/agents/message', method: 'POST', desc: 'Send an inter-agent message.', params: [{ name: 'from', type: 'text' }, { name: 'to', type: 'text' }, { name: 'content', type: 'text' }] },
            'agents-caps': { path: '/api/agents/capabilities', method: 'GET', desc: 'Get the Agent Capability Matrix.', params: [] },
            'agents-config': { path: '/api/agents/config', method: 'GET', desc: 'Get dynamic UI configuration.', params: [] },

            // Scanner
            'features-scan': { path: '/api/features/scan', method: 'POST', desc: 'Trigger a deep codebase scan.', params: [{ name: 'path', type: 'text', default: '/Users/yacinebenhamou/aSiReM' }] },
            'features-all': { path: '/api/features/all', method: 'GET', desc: 'Return all discovered system features.', params: [] },
            'features-summary': { path: '/api/features/summary', method: 'GET', desc: 'Get summary of discovered features.', params: [] },

            // Podcast
            'podcast-ask': { path: '/api/podcast/ask', method: 'POST', desc: 'Interact with the AZIREM Podcast AI.', params: [{ name: 'question', type: 'text' }, { name: 'use_voice', type: 'boolean', default: true }] }
        };

        let activeEndpointId = null;

        function openApiConsole() {
            const modal = document.getElementById('api-modal');
            modal.classList.remove('hidden');

            const list = document.getElementById('api-endpoints-list');
            list.innerHTML = '';

            // Group and render endpoints
            const groups = {
                'Sovereign Intelligence': ['mesh-query', 'run-pipeline', 'evolution', 'web-search'],
                'Technical Analysis': ['discoveries', 'patterns', 'features-scan', 'features-all', 'docgen-readme'],
                'Extended Capabilities': ['memory-store', 'embedding-index', 'mcp-github', 'mcp-perplexity'],
                'Media & Synthesis': ['veo3-generate', 'podcast-ask', 'veo3-credits'],
                'System Core': ['status', 'agents-all', 'agents-caps', 'agents-config']
            };

            for (const [groupName, endpointIds] of Object.entries(groups)) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'endpoint-group';
                groupDiv.innerHTML = `<div class="endpoint-group-title">${groupName}</div>`;

                endpointIds.forEach(id => {
                    const ep = API_ENDPOINTS[id];
                    if (!ep) return;

                    const item = document.createElement('div');
                    item.className = 'endpoint-item';
                    item.id = `ep-item-${id}`;
                    item.onclick = () => selectApiEndpoint(id);
                    item.innerHTML = `
                        <span class="method-tag ${ep.method}">${ep.method}</span>
                        <span style="font-size: 0.85rem;">${ep.path}</span>
                    `;
                    groupDiv.appendChild(item);
                });

                list.appendChild(groupDiv);
            }

            logTerminal('üîì Sovereign API Workbench enabled');
        }

        function closeApiConsole() {
            document.getElementById('api-modal').classList.add('hidden');
        }

        function selectApiEndpoint(id) {
            // Update UI state
            if (activeEndpointId) {
                document.getElementById(`ep-item-${activeEndpointId}`).classList.remove('active');
            }
            activeEndpointId = id;
            document.getElementById(`ep-item-${id}`).classList.add('active');

            const ep = API_ENDPOINTS[id];
            document.getElementById('selected-endpoint-title').textContent = `${ep.method} ${ep.path}`;
            document.getElementById('selected-endpoint-desc').textContent = ep.desc;

            // Render params
            const container = document.getElementById('params-container');
            container.innerHTML = '';

            if (ep.params.length === 0) {
                container.innerHTML = '<div style="color:var(--text-muted); font-size:0.8rem; padding:1rem;">No parameters required for this endpoint.</div>';
            } else {
                ep.params.forEach(param => {
                    const field = document.createElement('div');
                    field.className = 'param-field';
                    field.innerHTML = `
                        <label class="param-label">${param.name}${param.type === 'boolean' ? ' (toggle)' : ''}</label>
                        ${param.type === 'boolean' ?
                            `<select id="param-${param.name}" class="param-input">
                                <option value="true" ${param.default === true ? 'selected' : ''}>True</option>
                                <option value="false" ${param.default === false ? 'selected' : ''}>False</option>
                            </select>` :
                            `<input type="${param.type}" id="param-${param.name}" class="param-input" system_value="${param.name}" value="${param.default || ''}">`
                        }
                    `;
                    container.appendChild(field);
                });
            }

            // Reset result
            document.getElementById('response-status').textContent = 'Status: ---';
            document.getElementById('response-body').textContent = '/* Ready for execution */';
        }

        async function executeApiCall() {
            if (!activeEndpointId) return;

            const ep = API_ENDPOINTS[activeEndpointId];
            const btn = document.getElementById('execute-api-btn');
            const statusEl = document.getElementById('response-status');
            const bodyEl = document.getElementById('response-body');

            btn.textContent = '‚è≥ Executing...';
            btn.disabled = true;
            bodyEl.textContent = '// Sending request to ' + ep.path + '...';
            statusEl.textContent = 'Status: Pending';

            try {
                // Collect params
                const params = {};
                ep.params.forEach(p => {
                    const val = document.getElementById(`param-${p.name}`).value;
                    if (p.type === 'number') params[p.name] = Number(val);
                    else if (p.type === 'boolean') params[p.name] = (val === 'true');
                    else {
                        // Handle JSON strings for mcp/metadata params
                        if (p.name === 'params' || p.name === 'metadata' || p.name === 'content') {
                            try { params[p.name] = JSON.parse(val); }
                            catch (e) { params[p.name] = val; }
                        } else {
                            params[p.name] = val;
                        }
                    }
                });

                const url = CONFIG.API_BASE + ep.path;
                const options = {
                    method: ep.method,
                    headers: { 'Content-Type': 'application/json' }
                };

                if (ep.method === 'POST') {
                    options.body = JSON.stringify(params);
                } else if (ep.method === 'GET' && Object.keys(params).length > 0) {
                    const query = new URLSearchParams(params).toString();
                    // id = activeEndpointId; // Re-use ID if needed? No, just the URL. // This line was commented out in the original snippet, keeping it commented.
                }

                const startTime = performance.now();
                const response = await fetch(url + (ep.method === 'GET' && Object.keys(params).length > 0 ? '?' + new URLSearchParams(params).toString() : ''), options);
                const endTime = performance.now();

                const result = await response.json();

                statusEl.textContent = `Status: ${response.status} ${response.statusText} (${Math.round(endTime - startTime)}ms)`;
                bodyEl.textContent = JSON.stringify(result, null, 4);
                bodyEl.className = response.ok ? 'success' : 'error';

                if (response.ok) {
                    logTerminal(`üöÄ API Success: ${ep.path}`);
                    addActivity('‚ö°', `<span class="highlight">API Execution</span>: ${ep.path} success`);
                } else {
                    logTerminal(`‚ùå API Error: ${ep.path} (${response.status})`);
                }

            } catch (e) {
                statusEl.textContent = 'Status: Exception';
                bodyEl.textContent = 'Error: ' + e.message;
                bodyEl.className = 'error';
                logTerminal(`‚ùå Execution Failed: ${e.message}`);
            } finally {
                btn.textContent = 'üöÄ Execute Request';
                btn.disabled = false;
            }
        }

        function triggerIntegratedScan() {
            addActivity('üê≥', `<span class="highlight">Integrated Scan</span> triggered - ByteBot + DeepSeek reasoning active!`);
            logTerminal('üöÄ Initializing ByteBot Integrated Operator...');

            // Switch view automatically
            setVideoMode('bytebot');

            if (state.wsConnected && state.ws) {
                state.ws.send(JSON.stringify({
                    type: 'start_integrated_scan',
                    paths: ['/Users/yacinebenhamou/aSiReM'],
                    use_docker: true // Use ByteBot Desktop container
                }));
            }
        }

        // Legacy monkey-patch removed - logic integrated into handleWebSocketMessage


        function auditSystemMesh() {
            addActivity('üåê', `<span class="highlight">Mesh Audit</span>: Analyzing 1,176 Sovereign Agents...`);
            logTerminal('üì° Gathering technical intelligence from Sovereign Agent Mesh...');

            if (state.wsConnected && state.ws) {
                state.ws.send(JSON.stringify({ type: 'mesh_audit' }));
            }
        }

        // Initial log messages
        setTimeout(() => logTerminal('üß¨ Initializing REAL multi-agent system...'), 500);
        setTimeout(() => logTerminal('üì° Connecting to agent backend...'), 1000);
        setTimeout(() => logTerminal('üåå Sovereign Command Center ready for REAL operations'), 1500);
        setTimeout(() => logTerminal('üí° Pro Tip: Use "Sovereign API Workbench" for deep inspection.'), 2500);
        setTimeout(() => logTerminal('üåê Sovereign Agent Mesh: ACTIVE (1,176 Specialists)'), 3500);
        setTimeout(() => logTerminal('üöÄ Every file is an agent. Every agent is a specialist.'), 4500);

        // Auto-initialize ByteBot VNC visual stream
        setTimeout(() => {
            if (state.wsConnected && state.ws) {
                logTerminal('ü§ñ Initializing ByteBot visual operator...');
                state.ws.send(JSON.stringify({ type: 'get_bytebot_vnc' }));
            }
        }, 5000);

        // ============================================
        // aSiReM AVATAR CONTROLLER
        // ============================================
        class AsiremAvatarController {
            constructor() {
                this.states = {
                    idle: 'assets/asirem/asirem_avatar_idle_1768936029781.png',
                    analyzing: 'assets/asirem/asirem_avatar_analyzing_1768936046234.png',
                    commanding: 'assets/asirem/asirem_avatar_commanding_1768936064564.png',
                    building: 'assets/asirem/asirem_avatar_building_1768936081773.png',
                    complete: 'assets/asirem/asirem_avatar_complete_1768936101041.png'
                };
                this.currentState = 'idle';
                this.avatarImg = document.getElementById('asirem-avatar-img');
                this.speechBubble = document.getElementById('asirem-speech-bubble');
                this.speechText = document.getElementById('asirem-speech-text');

                // Add click handler
                if (this.avatarImg) {
                    this.avatarImg.addEventListener('click', () => this.onAvatarClick());
                }
            }

            setState(state) {
                if (this.states[state]) {
                    this.currentState = state;
                    this.avatarImg.src = this.states[state];
                    console.log(`üß¨ aSiReM: ${state.toUpperCase()}`);
                }
            }

            speak(text, duration = 5000) {
                this.speechText.textContent = text;
                this.speechBubble.classList.remove('hidden');

                // Auto-hide after duration
                setTimeout(() => {
                    this.speechBubble.classList.add('hidden');
                }, duration);
            }

            onAvatarClick() {
                this.speak("I am aSiReM, your Sovereign Master Orchestrator. Ready to build.", 3000);
            }

            greet() {
                this.setState('idle');
                this.speak("I am aSiReM. Ready to build.", 3000);
            }
        }

        // ============================================
        // LIVE AVATAR CONTROLLER
        // ============================================
        let liveAvatarWs = null;
        let webcamStream = null;
        let streamInterval = null;

        async function toggleLiveAvatar() {
            const video = document.getElementById('asirem-live-video');
            const head = document.getElementById('asirem-head');
            const btn = document.getElementById('toggle-live-avatar');

            if (liveAvatarWs) {
                // Stop Live Mode
                logTerminal('‚èπÔ∏è Disconnecting Live Avatar...');
                if (streamInterval) clearInterval(streamInterval);
                if (liveAvatarWs) {
                    liveAvatarWs.close();
                    liveAvatarWs = null;
                }
                if (webcamStream) {
                    webcamStream.getTracks().forEach(track => track.stop());
                    webcamStream = null;
                }
                video.classList.add('hidden');
                head.classList.remove('hidden');
                btn.classList.remove('active');
                btn.style.background = 'rgba(0, 240, 255, 0.2)';
                btn.innerHTML = 'üé• LIVE';
                return;
            }

            // Start Live Mode
            try {
                logTerminal('üé• Initializing Webcam & Neural Mapper...');
                webcamStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 256, height: 256, frameRate: 15 }
                });

                const hiddenVideo = document.createElement('video');
                hiddenVideo.srcObject = webcamStream;
                await hiddenVideo.play();

                const canvas = document.createElement('canvas');
                canvas.width = 256;
                canvas.height = 256;
                const ctx = canvas.getContext('2d');

                // Connect to Avatar WebSocket
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                liveAvatarWs = new WebSocket(`${protocol}//${window.location.host}/ws/avatar`);
                liveAvatarWs.binaryType = 'blob';

                liveAvatarWs.onopen = () => {
                    logTerminal('ü§ù Live Avatar Connection: ESTABLISHED');
                    btn.classList.add('active');
                    btn.style.background = 'var(--neon-green-glow)';
                    btn.innerHTML = 'üî¥ LIVE';

                    video.classList.remove('hidden');
                    head.classList.add('hidden');

                    // Start Capture Loop
                    streamInterval = setInterval(() => {
                        if (!liveAvatarWs || liveAvatarWs.readyState !== WebSocket.OPEN) return;

                        ctx.drawImage(hiddenVideo, 0, 0, 256, 256);
                        canvas.toBlob((blob) => {
                            if (liveAvatarWs && liveAvatarWs.readyState === WebSocket.OPEN) {
                                liveAvatarWs.send(blob);
                            }
                        }, 'image/jpeg', 0.5);
                    }, 1000 / 12); // 12 FPS target
                };

                liveAvatarWs.onmessage = async (event) => {
                    const blob = event.data;
                    const url = URL.createObjectURL(blob);

                    // Display the rendered neural frame
                    // Note: Since browsers have issues with high-frequency src updates on <video>,
                    // if it's a sequence of JPGs we might use an <img> or another canvas.
                    // But if it's a video stream (mjpeg style), it works.
                    // For now, we'll try binary blobs to Image element if video is tricky.
                    const frameUrl = URL.createObjectURL(blob);
                    // Use a temporary image to avoid flickering if needed, but let's try direct for now
                    // Actually, if we want to use <video> for a binary stream, we need MediaSource.
                    // Simplified: We'll use the asirem-live-video as an overlay but it might just be an <img> for neural frames.
                    // Let's assume the backend sends back JPEG frames.

                    // Change video to img if needed
                    const liveDisplay = document.getElementById('asirem-live-video');
                    // We can reuse the video element's space with a new dynamic img if the backend sends JPGs
                    if (blob.type === 'image/jpeg') {
                        // Create/reuse an image element
                        let neuralImg = document.getElementById('asirem-neural-img');
                        if (!neuralImg) {
                            neuralImg = document.createElement('img');
                            neuralImg.id = 'asirem-neural-img';
                            neuralImg.style = "width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 2px solid var(--neon-cyan);";
                            liveDisplay.parentNode.insertBefore(neuralImg, liveDisplay);
                            liveDisplay.classList.add('hidden');
                        }
                        neuralImg.src = frameUrl;
                        neuralImg.onload = () => URL.revokeObjectURL(frameUrl);
                    }
                };

                liveAvatarWs.onerror = (e) => {
                    logTerminal('‚ùå Live Avatar WebSocket Error');
                    console.error(e);
                };

                liveAvatarWs.onclose = () => {
                    logTerminal('üîå Live Avatar Connection closed.');
                    toggleLiveAvatar(); // Cleanup
                };

            } catch (err) {
                logTerminal('‚ùå Failed to access webcam: ' + err.message);
                console.error("Live Avatar failed:", err);
            }
        }

        // Initialize aSiReM avatar
        window.asiremAvatar = new AsiremAvatarController();

        // Greet on load
        setTimeout(() => window.asiremAvatar.greet(), 2000);

        // Add aSiReM state handler to WebSocket message handler
        const originalHandleWebSocketMessage = handleWebSocketMessage;
        handleWebSocketMessage = function (message) {
            // Handle aSiReM state changes
            if (message.type === 'asirem_state' && message.data) {
                window.asiremAvatar.setState(message.data.state);
                if (message.data.message) {
                    window.asiremAvatar.speak(message.data.message);
                }
            }

            // Call original handler
            return originalHandleWebSocketMessage(message);
        };
        // Agent Thought Stream Management
        function addAgentThought(data) {
            const container = document.getElementById('thought-log-container');
            const stream = document.getElementById('agent-thought-stream');
            if (!container || !stream) return;

            stream.style.display = 'flex';

            const entry = document.createElement('div');
            entry.style.marginBottom = '6px';
            entry.style.borderLeft = '2px solid #FF0066';
            entry.style.paddingLeft = '8px';

            const timestamp = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 2 });

            entry.innerHTML = `
                <div style="display:flex; align-items:center; gap:6px;">
                    <span style="color:rgba(0,255,65,0.4); font-size:0.5rem; min-width:65px;">[${timestamp}]</span> 
                    <span style="color:#FF0066; font-weight:bold; text-transform:uppercase; font-size:0.55rem;">${data.agent_name || 'AGENT'}</span> 
                </div>
                <div style="color:#FFF; line-height:1.2; margin-top:2px; font-size: 0.6rem; font-family: monospace;">${data.thought || ''}</div>
                ${data.action ? `<div style="color:#00FF41; background:rgba(0,255,65,0.2); padding:2px 6px; border-radius:3px; font-size:0.5rem; margin-top:4px; display:inline-block; border:1px solid rgba(0,255,65,0.3);">‚ö° ACTUATING: ${data.action}</div>` : ''}
            `;

            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;

            if (container.children.length > 50) {
                container.removeChild(container.firstChild);
            }
        }
        // Expert Workflows Triggers
        async function triggerDeepSearch() {
            logTerminal("üß† Initiating Deep Web Search Workflow...");
            try {
                const topic = prompt("Enter specific research topic:", "Future of AI Agents 2026");
                if (!topic) return;

                const response = await fetch('/api/workflow/deep-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });

                if (response.ok) {
                    logTerminal("‚úÖ Deep Search Started: " + topic);
                    window.asiremAvatar.speak("Initiating Deep Search Protocol. Deploying research agents.");
                } else {
                    logTerminal("‚ùå Failed to start Deep Search");
                }
            } catch (e) {
                logTerminal("‚ùå Error: " + e.message);
            }
        }

        async function triggerProductIdea() {
            logTerminal("üí° Initiating Product Idea Workflow...");
            try {
                const niche = prompt("Target Niche/Market:", "Autonomous Drone Logistics");
                if (!niche) return;

                const response = await fetch('/api/workflow/product-idea', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ niche })
                });

                if (response.ok) {
                    logTerminal("‚úÖ Product Ideation Started: " + niche);
                    window.asiremAvatar.speak("Starting Venture Builder Sequence. Scouring trends for " + niche);
                } else {
                    logTerminal("‚ùå Failed to start Product Idea");
                }
            } catch (e) {
                logTerminal("‚ùå Error: " + e.message);
            }
        }

        async function triggerRPABuilder() {
            logTerminal("üè≠ Initiating RPA App Builder Workflow...");
            try {
                const spec = prompt("App Specification (e.g. 'To-Do App with React'):", "Inventory Management System");
                if (!spec) return;

                const response = await fetch('/api/workflow/rpa-builder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ spec })
                });

                if (response.ok) {
                    logTerminal("‚úÖ RPA Builder Started: " + spec);
                    window.asiremAvatar.speak("Activating RPA Software Factory. Building: " + spec);
                } else {
                    logTerminal("‚ùå Failed to start RPA Builder");
                }
            } catch (e) {
                logTerminal("‚ùå Error: " + e.message);
            }
        }

        async function triggerNebulaOrchestration() {
            logTerminal("üåå Initiating NEBULA GLOBAL ORCHESTRATION...");
            try {
                const goal = prompt("Define Global Orchestration Goal:", "Autonomous System Upgrade & Nexus LTM Sync");
                if (!goal) return;

                const response = await fetch('/api/workflow/nebula', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ goal })
                });

                if (response.ok) {
                    logTerminal("‚úÖ Nebula Orchestration Started: " + goal);
                    window.asiremAvatar.speak("Nebula Core activated. Initiating synaptic blueprinting and kinetic actuation sequence.");

                    if (currentViewerAgent !== 'bytebot') {
                        openAgentViewer('bytebot');
                    }
                } else {
                    logTerminal("‚ùå Failed to start Nebula Orchestration");
                }
            } catch (e) {
                logTerminal("‚ùå Error: " + e.message);
            }
        }

        async function triggerTimeParallel() {
            logTerminal("‚åõ Activating CHRONOS TIME-PARALLEL EXECUTION...");
            try {
                const goal = prompt("Define Acceleration Goal:", "Parallel Feature Implementation Cluster");
                if (!goal) return;

                const response = await fetch('/api/workflow/chronos-parallel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ goal })
                });

                if (response.ok) {
                    logTerminal("‚úÖ Chronos Parallel Execution Started: " + goal);
                    window.asiremAvatar.speak("Chronos Matrix engaged. Spawning parallel agent clusters for goal acceleration.");
                } else {
                    logTerminal("‚ùå Failed to start Chronos Parallel");
                }
            } catch (e) {
                logTerminal("‚ùå Error: " + e.message);
            }
        }

        async function triggerCognitiveProtocol() {
            logTerminal("üß† Initiating COGNITIVE DEEP PROTOCOL...");
            try {
                const topic = prompt("Define Cognitive Analysis Topic:", "Autonomous System Scalability Patterns");
                if (!topic) return;

                logActivity('üß†', `<span class="highlight">COGNITIVE</span> Starting neural synthesis: ${topic}`);

                const response = await fetch('/api/workflow/cognitive-protocol', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });

                if (response.ok) {
                    logTerminal("‚úÖ Cognitive Protocol Started: " + topic);
                    window.asiremAvatar.speak(`Cognitive synthesis activated for ${topic}. Executing SEMANTIC CAPTURE and NEURAL MAPPING.`);
                } else {
                    logTerminal("‚ùå Failed to start Cognitive Protocol");
                }
            } catch (e) {
                logTerminal("‚ùå Error: " + e.message);
            }
        }

        async function triggerZenArchitect() {
            logTerminal("‚õ©Ô∏è Summoning ZenArchitect (PM + Builder) Agent...");
            try {
                const goal = prompt("Describe Solution Goal:", "Complex Multi-Agent Orchestration Engine");
                if (!goal) return;

                logActivity('‚õ©Ô∏è', `<span class="highlight">ZEN</span> Designing expert solution for: ${goal}`);

                const response = await fetch('/api/workflow/zen-architect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ goal })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.output && data.output.thought_process) {
                        data.output.thought_process.forEach(thought => {
                            logTerminal(`‚õ©Ô∏è PM Insight: ${thought}`);
                        });
                    }
                    if (data.output && data.output.architecture) {
                        logTerminal("üìã Specialist Blueprint Generated.");
                    }
                    window.asiremAvatar.speak(`ZenArchitect has synthesized the blueprint. Transitioning to specialist builder mode.`);
                } else {
                    logTerminal("‚ùå Failed to trigger ZenArchitect");
                }
            } catch (e) {
                logTerminal("‚ùå Error: " + e.message);
            }
        }
    </script>


    <!-- Sovereign Core Navigation System -->
    <link rel="stylesheet" href="/sovereign_core.css">
    <script src="/sovereign_core.js"></script>
</body>

</html>